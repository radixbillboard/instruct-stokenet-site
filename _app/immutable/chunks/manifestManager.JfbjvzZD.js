var Le=Object.defineProperty;var Be=(a,t,e)=>t in a?Le(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var u=(a,t,e)=>(Be(a,typeof t!="symbol"?t+"":t,e),e);import{d as v,w as f,r as ue,a as U}from"./index.buBIIApf.js";import{b as Ue,i as D,u as ye,d as ce,_ as me,f as Z,v as we,g as We,c as Ie,N as A,j as ze,k as Ge,l as He,m as X,n as de,o as W,p as Q,q as ee,M as te,t as Ze,w as $e,x as Ye,H as Je,y as je,z as qe,P as Xe,A as Qe,B as Fe,C as E,E as et,F as tt,G as st,I as nt,J as Ee}from"./entityCache.NalFR0CB.js";import{R as w,N as I,y as _e,v as it,w as at,V as L,a as Ne,L as rt}from"./caching.bDzEPiSu.js";import{v as se,e as ne}from"./entityProvider.mpR41C5v.js";import{X as o}from"./scheduler.lhSkUUv0.js";function ot(a){const t=a.key.value,e=a.value.fields[4],n=e.fields[1],i=e.fields[5].fields[0].entries;if(n.variant_id!=="0")throw new Error("Unhandled Schema: Schema is not of expected type SchemaV1");const r=new Ue(n.fields[0]),l=i.reduce((c,m)=>{const h=lt(m,r);return c[h.name]=h,c},{});return[{name:t,functions:l},r]}function lt(a,t){const e=a.key.value,[n,s,i]=a.value.fields;if(s.variant_id!=="0")throw new Error("Unhandled case TypeRef::Generic");const r=s.fields[0];if(r.variant_id!=="1")throw new Error("Unhandled case LocalTypeId::WellKnown");const l=parseInt(r.fields[0].value),d=t.extractFunctionArguments(l);if(i.variant_id!=="0")throw new Error("Unhandled case TypeRef::Generic");return{name:e,isMethod:n.variant_id==="1",args:d}}const Te=w.Utils.knownAddresses(I).then(a=>a.packageAddresses.packagePackage);async function ut(a,t){const e=await dt(a,t);if(!e)return;const i=(await ct(e)).fields[0].entries.map(d=>ot(d)),r={},l={};for(const[d,c]of i)r[d.name]=d,l["dummy_hash_"+se()]=c;return{blueprints:r,schemas:l}}async function dt(a,t){const s={kind:"String",value:`
    ALLOCATE_GLOBAL_ADDRESS
      Address("${await Te}")
      "Package"
      AddressReservation("${t}")
      NamedAddress("${t}")
    ;
    `+a};try{return(await w.Instructions.convert(s,I,"Parsed")).value[1]}catch(i){console.log(i);return}}async function ct(a){switch(a.kind){case"CallFunction":const n=await Te;if(a.packageAddress.kind!="Static"||a.packageAddress.value!=n||a.blueprintName!="Package"||a.functionName!="publish_wasm_advanced"&&a.functionName!="publish_native")throw new Error("Passed instruction is not a publish package instruction");break;default:throw new Error("Passed instruction is not a CallFunction instruction")}const t=await w.Instructions.compile({kind:"Parsed",value:[a]},I),e=await w.ManifestSbor.decodeToString(t,I,_e.ProgrammaticJson).then(JSON.parse);return a.functionName==="publish_wasm_advanced",e.elements[0].fields[3].fields[1]}class _{constructor(){u(this,"unsubscriber")}subscribe(t,e,n){const s=ce(this.constructFilterFunction(n));let i;this.unsubscriber=v([t,s],D).subscribe(([r,l])=>{const d=(l==null?void 0:l(r))??r;me.isEqual(d,i)||(i=d,e.set(d))})}unsubscribe(){var t;(t=this.unsubscriber)==null||t.call(this),this.unsubscriber=void 0}}class Ve extends _{constructFilterFunction(t){return f(void 0)}}class mt extends _{constructFilterFunction(t){const e=o(t.fixedArgs),n=e[0].value.currentValueNode(),s=e[1].value.currentValueNode(),i=e[2].value.currentValueNode(),r=e[3].value.currentValueNode();return v([n.value,s.value,i.value,r.value],([l,d,c,m])=>p=>{const N=[...p];return c&&N.push({kind:"AddressReservation",name:c,packageAddress:l,blueprintName:d,namedAddressName:m,isConsumed:!1}),m&&N.push({kind:"NamedAddress",name:m,packageAddress:l,blueprintName:d,addressReservationName:c,isConsumed:!1}),N})}}class C extends _{constructor(t){super(),this.config=t}constructFilterFunction(t){let e;const n=o(t.fixedArgs);if(this.config.resourceAddressArgIndex!=null){const i=n[this.config.resourceAddressArgIndex].value.currentValueNode();e=v(i.validStaticOrNamedAddress,async r=>{const l=await r;return(l==null?void 0:l.kind)==="static"?{entityVariant:l.entityVariant}:void 0})}else e=f(Promise.resolve({entityVariant:void 0}));const s=n[this.config.ownableNameArgIndex].value.currentValueNode();return v([e,s.value],([i,r])=>{if(!r.trim())return;const l=i.then(c=>(c==null?void 0:c.entityVariant)==="FungibleResource"?"Fungible":(c==null?void 0:c.entityVariant)==="NonFungibleResource"?"NonFungible":void 0);return c=>[...c,{kind:s.valueKind.kind,name:r,resourceVariant:l,isConsumed:!1}]})}static create(t){return class extends C{constructor(){super(t)}}}}class ie extends _{constructor(t){super(),this.config=t}constructFilterFunction(t){const e=o(t.fixedArgs),n=e[this.config.bucketNameArgIndex].value.currentValueNode(),s=e[this.config.proofNameArgIndex].value.currentValueNode();return v([n.value,s.value],([i,r])=>d=>{const c=d.find(m=>m.kind==="Bucket"&&m.name===i);if((c==null?void 0:c.kind)==="Bucket"&&r){const m={kind:"Proof",name:r,resourceVariant:c.resourceVariant,isConsumed:!1};return[...d,m]}else return d})}static create(t){return class extends ie{constructor(){super(t)}}}}class gt extends _{constructFilterFunction(t){const e=o(t.fixedArgs),n=e[0].value.currentValueNode(),s=e[1].value.currentValueNode();return v([n.value,s.value],([i,r])=>d=>{const c=d.find(m=>m.kind==="Proof"&&m.name===i);if(c&&r){const m={...c,name:r};return[...d,m]}else return d})}}class Me extends _{constructFilterFunction(t){return f(e=>e.map(n=>n.kind==="Proof"?{...n,isConsumed:!0}:n))}}class be extends _{constructFilterFunction(t){const n=o(t.fixedArgs)[0].value.currentValueNode();return v(n.value,s=>r=>r.map(l=>l.kind===n.valueKind.kind&&l.name===s?{...l,isConsumed:!0}:l))}}class Y extends _{constructFilterFunction(t){const e=Y.derivePublishConstellation(t);return v(e,(n,s)=>{if(!n){s(c=>c);return}const r=n.packageDefinitionNode.validationResult;let l=n.packageAddressNode;const d=l.validationResult;return v([r,d],D).subscribe(([c,m])=>{const h=o(l.value.values)[0],p=h==null?void 0:h.currentValueNode();if(!p){s(F=>F);return}const N=o(p.value),b=Y.getPackageDefinition(c,m,N,t);s(F=>F.map(O=>O.kind==="AddressReservation"&&O.name===N?{...O,packageDefinition:b}:O))})},void 0)}static async getPackageDefinition(t,e,n,s){if(!((await t).valid&&(await e).valid)&&n)return;const i=await s.toManifestString();return await ut(i,n)}static derivePublishConstellation(t){return ye(v(t.args,async e=>{const n=(await w.Utils.knownAddresses(I)).packageAddresses.packagePackage,s=o(t.command),i=await e;if(s==="PUBLISH_PACKAGE_ADVANCED"&&i.length===5)return{packageDefinitionNode:i[1].value.currentValueNode(),packageAddressNode:i[4].value.currentValueNode()};if(s==="CALL_FUNCTION"){const r=o(i[0].value.currentValueNode().value),l=o(i[1].value.currentValueNode().value),d=o(i[2].value.currentValueNode().value);if(r===n&&l==="Package"&&d==="publish_wasm_advanced"&&i.length===8)return{packageDefinitionNode:i[4].value.currentValueNode(),packageAddressNode:i[7].value.currentValueNode()}}}),void 0)}}class T extends _{constructFilterFunction(t){return v(t.argConsumedInputs,e=>e.length===0?void 0:s=>s.map(i=>e.find(l=>l.kind===i.kind&&l.name===i.name)!=null?{...i,isConsumed:!0}:i))}}class ge extends _{constructor(e){super();u(this,"filters");this.filters=e.map(n=>new n)}constructFilterFunction(e){const n=this.filters.map(s=>s.constructFilterFunction(e));return v(n,s=>r=>{let l=r;for(const d of Z(s))l=d(l);return l})}static create(...e){return class extends ge{constructor(){super(e)}}}}class vt{constructor(){u(this,"internalCache",new it(at))}async getScryptoPackage(t){if((await we(t,["Package"])).valid)return this.internalCache.get(t,()=>We.findPackage(t))}}const S=new vt;class ae{constructor(t){u(this,"argObserverUnsubscriber");u(this,"advisorUnsubscriber");this.observedArgsIndices=t}subscribe(t){this.argObserverUnsubscriber=t.args.subscribe(async e=>{var s;(s=this.advisorUnsubscriber)==null||s.call(this);const n=await e;if(n.length>Math.max(...this.observedArgsIndices)){const i=this.observedArgsIndices.map(r=>n[r].value.currentValueNode());this.advisorUnsubscriber=this.adviseInstruction(t,i)}})}unsubscribe(){var t,e;(t=this.advisorUnsubscriber)==null||t.call(this),(e=this.argObserverUnsubscriber)==null||e.call(this)}}class ht extends ae{constructor(){super([0,1])}adviseInstruction(t,e){const[n,s]=e;return n.value.subscribe(async i=>{const r=await S.getScryptoPackage(i);if(!r){s.clearOptions();return}const l=Object.keys(r.blueprints);s.setOptions(l)})}}class ft extends ae{constructor(){super([0,1])}adviseInstruction(t,e){const[n,s]=e;return n.validStaticOrNamedAddress.subscribe(async i=>{const r=await i;if(!r){s.clearOptions();return}const[l,d]=await Ce(r),c=l==null?void 0:l.blueprints[d??""],m=c?Object.values(c.functions).filter(h=>h.isMethod).map(h=>h.name):void 0;m!=null?s.setOptions(m):s.clearOptions()})}}class At extends ae{constructor(){super([0,1,2]);u(this,"previousPackageAddress");u(this,"selectedPackage")}adviseInstruction(e,n){const[s,i,r]=n;return v([s.validStaticOrNamedAddress,i.value,e.inputs],D).subscribe(async([l,d,c])=>{var b;const m=await l;if(!m){m!==this.previousPackageAddress&&(r.clearOptions(),i.clearOptions(),this.previousPackageAddress=m);return}if(m.kind==="named"){const k=c.find(F=>F.kind==="AddressReservation"&&F.namedAddressName===m.addressName);this.selectedPackage=(k==null?void 0:k.kind)==="AddressReservation"?await k.packageDefinition:void 0}else m.address!==this.previousPackageAddress&&(this.selectedPackage=await S.getScryptoPackage(m.address),this.previousPackageAddress=m.address);const h=this.selectedPackage?Object.keys(this.selectedPackage.blueprints):void 0,p=(b=this.selectedPackage)==null?void 0:b.blueprints[d],N=p?Object.values(p.functions).filter(k=>!k.isMethod).map(k=>k.name):void 0;h!=null?i.setOptions(h):i.clearOptions(),N!=null?r.setOptions(N):r.clearOptions()})}}class ve extends ae{constructor(t){super([t.addressArgIndex,t.methodNameArgIndex])}adviseInstruction(t,e){const[n,s]=e;return n.validStaticOrNamedAddress.subscribe(async i=>{var h;const r=await i;if(!r){s.clearOptions();return}const[l,d]=await Ce(r),c=(h=l==null?void 0:l.blueprints)==null?void 0:h[d??""],m=c?Object.values(c.functions).filter(p=>p.isMethod).map(p=>p.name):void 0;m!=null?s.setOptions(m):s.clearOptions()})}static create(t){return class extends ve{constructor(){super(t)}}}}class Nt extends ae{constructor(){super([0,1,2])}adviseInstruction(t,e){const[n,s,i]=e;return v([n.value,s.value.discriminatorValue],D).subscribe(async([r,l])=>{var h,p,N,b,k,F;const d=(p=(h=s.valueKind.variants)==null?void 0:h.get(l??-1))==null?void 0:p.name;if(!d){i.clearOptions();return}const c=await ne.getEntity(r);if(((N=c==null?void 0:c.details)==null?void 0:N.type)!=="Component"&&((b=c==null?void 0:c.details)==null?void 0:b.type)!=="FungibleResource"&&((k=c==null?void 0:c.details)==null?void 0:k.type)!=="NonFungibleResource"){i.clearOptions();return}const m=(F=c.details.roleAssignments)==null?void 0:F.entries.map(O=>O.role_key).filter(O=>O.module===d).map(O=>O.name);m?i.setOptions(m):i.clearOptions()})}}async function Ce(a){var n;let t,e;if(a.kind==="named"){const s=a.packageAddress;t=s?await S.getScryptoPackage(s):void 0,e=a.blueprintName}else{const s=await ne.getEntity(a.address),i=(n=s==null?void 0:s.details)==null?void 0:n.type;if(i==="Component"||i==="FungibleResource"||i==="NonFungibleResource"){const r=s==null?void 0:s.details.packageAddress;t=r?await S.getScryptoPackage(r):void 0,e=s==null?void 0:s.details.blueprintName}}return[t,e]}class he{}class P extends he{constructor(t){super(),this.functionReference=t}getVariableArgDefinitions(t){return f(this.getVariableArgDefinitionsAsync())}async getVariableArgDefinitionsAsync(){const e=(await w.Utils.knownAddresses(I)).packageAddresses[this.functionReference.wellKnownPackageName];return(await S.getScryptoPackage(e)).blueprints[this.functionReference.blueprintName].functions[this.functionReference.functionName].args}static create(t){return class extends P{constructor(){super(t)}}}}class pt extends he{getVariableArgDefinitions(t){const e=o(t.fixedArgs),n=e[0].value.currentValueNode(),s=e[1].value.currentValueNode(),i=e[2].value.currentValueNode();return v([n.validStaticOrNamedAddress,s.value,i.value,t.inputs],async([r,l,d,c])=>{var b;const m=await r;if(!m)return;let h;if(m.kind==="named"){const k=c.find(F=>F.kind==="AddressReservation"&&F.namedAddressName===m.addressName);h=(k==null?void 0:k.kind)==="AddressReservation"?await k.packageDefinition:void 0}else m.address&&(h=await S.getScryptoPackage(m.address));if(!h)return;const p=h.blueprints[l],N=(b=p==null?void 0:p.functions)==null?void 0:b[d];return(N==null?void 0:N.args)??[]})}}class bt extends he{getVariableArgDefinitions(t){const e=o(t.fixedArgs),n=e[0].value.currentValueNode(),s=e[1].value.currentValueNode();return v([n.validStaticOrNamedAddress,s.value],async([i,r])=>{var p,N;const l=await i;if(!l)return;let d,c;if(l.kind==="named")d=l.packageAddress?await S.getScryptoPackage(l.packageAddress):void 0,c=l.blueprintName;else{const b=await ne.getEntity(l.address),k=(p=b==null?void 0:b.details)==null?void 0:p.type;if(k==="Component"||k==="FungibleResource"||k==="NonFungibleResource"){const F=b==null?void 0:b.details.packageAddress;d=F?await S.getScryptoPackage(F):void 0,c=b==null?void 0:b.details.blueprintName}}if(!d)return;const m=d.blueprints[c??""],h=(N=m==null?void 0:m.functions)==null?void 0:N[r];return(h==null?void 0:h.args)??[]})}}class $ extends he{constructor(t){super(),this.args=t}getVariableArgDefinitions(t){return ue(f(Promise.resolve(this.args)))}static create(t){return class extends ${constructor(){super(t)}}}}class kt{constructor(){u(this,"argumentDefinitionsByCommand",new Map)}registerInstruction(t,e){this.argumentDefinitionsByCommand.set(t,{args:e.args,variableArgDefinitionsProvider:e.variableArgDefinitionsProvider??$.create([]),consumableFilter:e.consumableFilter,instructionAdvisor:e.instructionAdvisor})}lookupInstructionDefinition(t){const e=this.argumentDefinitionsByCommand.get(t);if(e===void 0)throw new Error(`No instruction defined for command ${t}`);return e}get commands(){return[...this.argumentDefinitionsByCommand.keys()]}}const g=new kt;g.registerInstruction("TAKE_FROM_WORKTOP",{args:[{valueKind:{kind:"Address",variants:["FungibleResource","NonFungibleResource"]},name:"Resource Address"},{valueKind:{kind:"Decimal"},name:"Amount"},{valueKind:{kind:"Bucket",mode:"produces"},name:"Bucket"}],consumableFilter:C.create({resourceAddressArgIndex:0,ownableNameArgIndex:2})});g.registerInstruction("TAKE_NON_FUNGIBLES_FROM_WORKTOP",{args:[{valueKind:{kind:"Address",variants:["NonFungibleResource"]},name:"Resource Address"},{valueKind:{kind:"Array",valuesKind:{kind:"NonFungibleLocalId"}},name:"IDs"},{valueKind:{kind:"Bucket",mode:"produces",variant:"NonFungible"},name:"Bucket"}],consumableFilter:C.create({resourceAddressArgIndex:0,ownableNameArgIndex:2})});g.registerInstruction("TAKE_ALL_FROM_WORKTOP",{args:[{valueKind:{kind:"Address",variants:["FungibleResource","NonFungibleResource"]},name:"Resource Address"},{valueKind:{kind:"Bucket",mode:"produces"},name:"Bucket"}],consumableFilter:C.create({resourceAddressArgIndex:0,ownableNameArgIndex:1})});g.registerInstruction("RETURN_TO_WORKTOP",{args:[{valueKind:{kind:"Bucket",mode:"consumes"},name:"Bucket"}],consumableFilter:be});g.registerInstruction("ASSERT_WORKTOP_CONTAINS",{args:[{valueKind:{kind:"Address",variants:["FungibleResource","NonFungibleResource"]},name:"Resource Address"},{valueKind:{kind:"Decimal"},name:"Amount"}]});g.registerInstruction("ASSERT_WORKTOP_CONTAINS_NON_FUNGIBLES",{args:[{valueKind:{kind:"Address",variants:["NonFungibleResource"]},name:"Resource Address"},{valueKind:{kind:"Array",valuesKind:{kind:"NonFungibleLocalId"}},name:"IDs"}]});g.registerInstruction("ASSERT_WORKTOP_CONTAINS_ANY",{args:[{valueKind:{kind:"Address",variants:["FungibleResource","NonFungibleResource"]},name:"Resource Address"}]});g.registerInstruction("POP_FROM_AUTH_ZONE",{args:[{valueKind:{kind:"Proof",mode:"produces"},name:"Proof"}],consumableFilter:C.create({resourceAddressArgIndex:void 0,ownableNameArgIndex:0})});g.registerInstruction("PUSH_TO_AUTH_ZONE",{args:[{valueKind:{kind:"Proof",mode:"consumes"},name:"Proof"}]});g.registerInstruction("CREATE_PROOF_FROM_AUTH_ZONE_OF_AMOUNT",{args:[{valueKind:{kind:"Address",variants:["FungibleResource"]},name:"Resource Address"},{valueKind:{kind:"Decimal"},name:"Amount"},{valueKind:{kind:"Proof",mode:"produces",variant:"Fungible"},name:"Proof"}],consumableFilter:C.create({resourceAddressArgIndex:0,ownableNameArgIndex:2})});g.registerInstruction("CREATE_PROOF_FROM_AUTH_ZONE_OF_NON_FUNGIBLES",{args:[{valueKind:{kind:"Address",variants:["NonFungibleResource"]},name:"Resource Address"},{valueKind:{kind:"Array",valuesKind:{kind:"NonFungibleLocalId"}},name:"IDs"},{valueKind:{kind:"Proof",mode:"produces",variant:"NonFungible"},name:"Proof"}],consumableFilter:C.create({resourceAddressArgIndex:0,ownableNameArgIndex:2})});g.registerInstruction("CREATE_PROOF_FROM_AUTH_ZONE_OF_ALL",{args:[{valueKind:{kind:"Address",variants:["FungibleResource","NonFungibleResource"]},name:"Resource Address"},{valueKind:{kind:"Proof",mode:"produces"},name:"Proof"}],consumableFilter:C.create({resourceAddressArgIndex:0,ownableNameArgIndex:1})});g.registerInstruction("DROP_NAMED_PROOFS",{args:[],consumableFilter:Me});g.registerInstruction("DROP_ALL_PROOFS",{args:[],consumableFilter:Me});g.registerInstruction("DROP_AUTH_ZONE_PROOFS",{args:[]});g.registerInstruction("DROP_AUTH_ZONE_REGULAR_PROOFS",{args:[]});g.registerInstruction("DROP_AUTH_ZONE_SIGNATURE_PROOFS",{args:[]});g.registerInstruction("CREATE_PROOF_FROM_BUCKET_OF_AMOUNT",{args:[{valueKind:{kind:"Bucket",mode:"inert",variant:"Fungible"},name:"Bucket"},{valueKind:{kind:"Decimal"},name:"Amount"},{valueKind:{kind:"Proof",mode:"produces"},name:"Proof"}],consumableFilter:ie.create({bucketNameArgIndex:0,proofNameArgIndex:2})});g.registerInstruction("CREATE_PROOF_FROM_BUCKET_OF_NON_FUNGIBLES",{args:[{valueKind:{kind:"Bucket",mode:"inert",variant:"NonFungible"},name:"Bucket"},{valueKind:{kind:"Array",valuesKind:{kind:"NonFungibleLocalId"}},name:"IDs"},{valueKind:{kind:"Proof",mode:"produces"},name:"Proof"}],consumableFilter:ie.create({bucketNameArgIndex:0,proofNameArgIndex:2})});g.registerInstruction("CREATE_PROOF_FROM_BUCKET_OF_ALL",{args:[{valueKind:{kind:"Bucket",mode:"inert"},name:"Bucket"},{valueKind:{kind:"Proof",mode:"produces"},name:"Proof"}],consumableFilter:ie.create({bucketNameArgIndex:0,proofNameArgIndex:1})});g.registerInstruction("BURN_RESOURCE",{args:[{valueKind:{kind:"Bucket",mode:"consumes"},name:"Bucket"}],consumableFilter:be});g.registerInstruction("CLONE_PROOF",{args:[{valueKind:{kind:"Proof",mode:"inert"},name:"Proof"},{valueKind:{kind:"Proof",mode:"produces"},name:"Cloned Proof"}],consumableFilter:gt});g.registerInstruction("DROP_PROOF",{args:[{valueKind:{kind:"Proof",mode:"consumes"},name:"Proof"}],consumableFilter:be});g.registerInstruction("CALL_FUNCTION",{args:[{valueKind:{kind:"Address",variants:["Package"],allowsNamedAddress:!0},name:"Package Address"},{valueKind:{kind:"String",allowBlank:!1},name:"Blueprint name"},{valueKind:{kind:"String",allowBlank:!1},name:"Function name"}],variableArgDefinitionsProvider:pt,consumableFilter:ge.create(T,Y),instructionAdvisor:At});g.registerInstruction("CALL_METHOD",{args:[{valueKind:{kind:"Address",variants:["Component","FungibleResource","NonFungibleResource"],allowsNamedAddress:!0},name:"Component Address"},{valueKind:{kind:"String",allowBlank:!1},name:"Method Name"}],variableArgDefinitionsProvider:bt,consumableFilter:T,instructionAdvisor:ft});g.registerInstruction("ALLOCATE_GLOBAL_ADDRESS",{args:[{valueKind:{kind:"Address",variants:["Package"]},name:"Package Address"},{valueKind:{kind:"String",allowBlank:!1},name:"Blueprint Name"},{valueKind:{kind:"AddressReservation",mode:"produces"},name:"Address Reservation Name"},{valueKind:{kind:"NamedAddress",mode:"produces"},name:"Address Name"}],consumableFilter:mt,instructionAdvisor:ht});g.registerInstruction("PUBLISH_PACKAGE_ADVANCED",{args:[],variableArgDefinitionsProvider:P.create({wellKnownPackageName:"packagePackage",blueprintName:"Package",functionName:"publish_wasm_advanced"}),consumableFilter:ge.create(Y,T)});g.registerInstruction("SET_METADATA",{args:[{valueKind:{kind:"Address",allowsNamedAddress:!0},name:"Entity Address"}],variableArgDefinitionsProvider:$.create([{valueKind:{kind:"String",allowBlank:!1},name:"Field Name"},{valueKind:{kind:"WellKnownReference",name:"METADATA_VALUE"},name:"Value"}])});g.registerInstruction("LOCK_METADATA",{args:[{valueKind:{kind:"Address",allowsNamedAddress:!0},name:"Address"}],variableArgDefinitionsProvider:$.create([{valueKind:{kind:"String",allowBlank:!1},name:"Field Name"}])});g.registerInstruction("REMOVE_METADATA",{args:[{valueKind:{kind:"Address",allowsNamedAddress:!0},name:"Address"}],variableArgDefinitionsProvider:$.create([{valueKind:{kind:"String",allowBlank:!1},name:"Field Name"}])});g.registerInstruction("MINT_FUNGIBLE",{args:[{valueKind:{kind:"Address",variants:["FungibleResource"]},name:"Resource Address"},{valueKind:{kind:"Decimal"},name:"Amount"}]});g.registerInstruction("MINT_NON_FUNGIBLE",{args:[{valueKind:{kind:"Address",variants:["NonFungibleResource"]},name:"Resource Address"},{valueKind:{kind:"Map",keysKind:{kind:"NonFungibleLocalId"},valuesKind:{kind:"Tuple"}},name:"Non Fungibles"}]});g.registerInstruction("MINT_RUID_NON_FUNGIBLE",{args:[{valueKind:{kind:"Address",variants:["NonFungibleResource"]},name:"Resource Address"},{valueKind:{kind:"Array",valuesKind:{kind:"Tuple"}},name:"Non Fungibles"}]});g.registerInstruction("CREATE_FUNGIBLE_RESOURCE",{args:[],variableArgDefinitionsProvider:P.create({wellKnownPackageName:"resourcePackage",blueprintName:"FungibleResourceManager",functionName:"create"}),consumableFilter:T});g.registerInstruction("CREATE_FUNGIBLE_RESOURCE_WITH_INITIAL_SUPPLY",{args:[],variableArgDefinitionsProvider:P.create({wellKnownPackageName:"resourcePackage",blueprintName:"FungibleResourceManager",functionName:"create_with_initial_supply"}),consumableFilter:T});g.registerInstruction("CREATE_NON_FUNGIBLE_RESOURCE",{args:[],variableArgDefinitionsProvider:P.create({wellKnownPackageName:"resourcePackage",blueprintName:"NonFungibleResourceManager",functionName:"create"}),consumableFilter:T});g.registerInstruction("CREATE_NON_FUNGIBLE_RESOURCE_WITH_INITIAL_SUPPLY",{args:[],variableArgDefinitionsProvider:P.create({wellKnownPackageName:"resourcePackage",blueprintName:"NonFungibleResourceManager",functionName:"create_with_initial_supply"}),consumableFilter:T});g.registerInstruction("RECALL_FROM_VAULT",{args:[{valueKind:{kind:"Address",variants:["FungibleVault","NonFungibleVault"]},name:"Vault Address"}],variableArgDefinitionsProvider:P.create({wellKnownPackageName:"resourcePackage",blueprintName:"FungibleVault",functionName:"recall"})});g.registerInstruction("RECALL_NON_FUNGIBLES_FROM_VAULT",{args:[{valueKind:{kind:"Address",variants:["NonFungibleVault"]},name:"Vault Address"}],variableArgDefinitionsProvider:P.create({wellKnownPackageName:"resourcePackage",blueprintName:"NonFungibleVault",functionName:"recall_non_fungibles"})});g.registerInstruction("FREEZE_VAULT",{args:[{valueKind:{kind:"Address",variants:["FungibleVault","NonFungibleVault"]},name:"Vault Address"}],variableArgDefinitionsProvider:P.create({wellKnownPackageName:"resourcePackage",blueprintName:"FungibleVault",functionName:"freeze"})});g.registerInstruction("UNFREEZE_VAULT",{args:[{valueKind:{kind:"Address",variants:["FungibleVault","NonFungibleVault"]},name:"Vault Address"}],variableArgDefinitionsProvider:P.create({wellKnownPackageName:"resourcePackage",blueprintName:"FungibleVault",functionName:"unfreeze"})});g.registerInstruction("SET_OWNER_ROLE",{args:[{valueKind:{kind:"Address",allowsNamedAddress:!0},name:"Entity Address"}],variableArgDefinitionsProvider:P.create({wellKnownPackageName:"roleAssignmentModulePackage",blueprintName:"RoleAssignment",functionName:"set_owner"})});g.registerInstruction("LOCK_OWNER_ROLE",{args:[{valueKind:{kind:"Address",allowsNamedAddress:!0},name:"Entity Address"}],variableArgDefinitionsProvider:P.create({wellKnownPackageName:"roleAssignmentModulePackage",blueprintName:"RoleAssignment",functionName:"lock_owner"})});g.registerInstruction("SET_ROLE",{args:[{valueKind:{kind:"Address",allowsNamedAddress:!0},name:"Entity Address"}],variableArgDefinitionsProvider:P.create({wellKnownPackageName:"roleAssignmentModulePackage",blueprintName:"RoleAssignment",functionName:"set"}),instructionAdvisor:Nt});g.registerInstruction("CREATE_ACCESS_CONTROLLER",{args:[],variableArgDefinitionsProvider:P.create({wellKnownPackageName:"accessControllerPackage",blueprintName:"AccessController",functionName:"create"}),consumableFilter:T});g.registerInstruction("SET_COMPONENT_ROYALTY",{args:[{valueKind:{kind:"Address",variants:["Component"],allowsNamedAddress:!0},name:"Component Address"}],variableArgDefinitionsProvider:P.create({wellKnownPackageName:"royaltyModulePackage",blueprintName:"ComponentRoyalty",functionName:"set_royalty"}),instructionAdvisor:ve.create({addressArgIndex:0,methodNameArgIndex:1})});g.registerInstruction("LOCK_COMPONENT_ROYALTY",{args:[{valueKind:{kind:"Address",variants:["Component"],allowsNamedAddress:!0},name:"Component Address"}],variableArgDefinitionsProvider:P.create({wellKnownPackageName:"royaltyModulePackage",blueprintName:"ComponentRoyalty",functionName:"lock_royalty"}),instructionAdvisor:ve.create({addressArgIndex:0,methodNameArgIndex:1})});g.registerInstruction("CLAIM_PACKAGE_ROYALTIES",{args:[{valueKind:{kind:"Address",variants:["Package"],allowsNamedAddress:!0},name:"Package Address"}]});g.registerInstruction("CLAIM_COMPONENT_ROYALTIES",{args:[{valueKind:{kind:"Address",variants:["Component"],allowsNamedAddress:!0},name:"Component Address"}]});g.registerInstruction("CREATE_ACCOUNT",{args:[]});g.registerInstruction("CREATE_ACCOUNT_ADVANCED",{args:[],variableArgDefinitionsProvider:P.create({wellKnownPackageName:"accountPackage",blueprintName:"Account",functionName:"create_advanced"}),consumableFilter:T});g.registerInstruction("CREATE_IDENTITY",{args:[]});g.registerInstruction("CREATE_IDENTITY_ADVANCED",{args:[],variableArgDefinitionsProvider:P.create({wellKnownPackageName:"identityPackage",blueprintName:"Identity",functionName:"create_advanced"})});g.registerInstruction("CREATE_VALIDATOR",{args:[],variableArgDefinitionsProvider:P.create({wellKnownPackageName:"consensusManagerPackage",blueprintName:"ConsensusManager",functionName:"create_validator"}),consumableFilter:T});const Pt=["Any","Bool","I8","I16","I32","I64","I128","U8","U16","U32","U64","U128","String","Tuple","Enum","Array","Map","Address","NamedAddress","AddressReservation","Bucket","Proof","Expression","Blob","Decimal","PreciseDecimal","NonFungibleLocalId","NonFungibleGlobalId","Bytes","LocalSchemaReference","WellKnownReference"],es=Pt.filter(a=>!["Any","Blob","LocalSchemaReference","WellKnownReference"].includes(a)).toSorted(),ts=["Component","Package","FungibleResource","NonFungibleResource","FungibleVault","NonFungibleVault","Other"];function z(a,t){return a.kind==="WellKnownReference"?Ie(a.name,t):a.kind==="LocalSchemaReference"?a.localSchemaReference.resolveToValueKind():a}function G(a,t){return a==="Bucket"||a==="Proof"||a==="AddressReservation"?{kind:a,mode:t}:{kind:a}}class V{constructor(t,e,n){u(this,"consumedInputs");this.valueKind=t,this.value=e,this.instruction=n}isEmbeddable(){return!1}getChildValueNodes(){return[]}}class Se extends V{constructor(e){super({kind:void 0},f(""),e);u(this,"validationResult",f(Promise.resolve(A.error({message:"Value kind not selected",context:"ValueNode"}))))}reset(){this.value.set("")}async toManifestString(){return"???"}initializeFromProgrammaticValue(e){}initializeFromPersistentValue(e){}toPersistableValue(){return{kind:"Any"}}}class Ft extends V{constructor(e,n){super(e,f(null),n);u(this,"validationResult");this.validationResult=v(this.value,async s=>s==null?A.error({message:"Value missing",context:"ValueNode"}):s!=="true"&&s!=="false"?A.error({message:`${s} is not a valid boolean`,context:"ValueNode"}):A.ok())}reset(){this.value.set(null)}async toManifestString(){return`${o(this.value)}`}isEmbeddable(){return!0}initializeFromProgrammaticValue(e){this.value.set(`${e.value}`)}initializeFromPersistentValue(e){this.value.set(e.value)}toPersistableValue(){return{kind:"Bool",value:o(this.value)}}}class y extends V{constructor(e,n){super(e,f(""),n);u(this,"validationResult");this.validationResult=v(this.value,async s=>{if(!s)return A.error({message:"Value missing",context:"ValueNode"});try{const i=BigInt(s);return ze.get(this.valueKind.kind).validate(i)}catch{return A.error({message:"Cannot parse integer",context:"ValueNode"})}})}reset(){this.value.set("")}async toManifestString(){return`${o(this.value)}${this.valueKind.kind.toLowerCase()}`}isEmbeddable(){return!0}initializeFromProgrammaticValue(e){this.value.set(e.value.toString())}initializeFromPersistentValue(e){this.value.set(e.value)}toPersistableValue(){return{kind:this.valueKind.kind,value:o(this.value)}}}class Et extends V{constructor(e,n){super(e,f(""),n);u(this,"options",f(void 0));u(this,"validationResult");this.validationResult=v([this.value,this.options],async([s,i])=>i!=null?i.includes(s)?A.ok():A.error({message:"Value missing",context:"ValueNode"}):(this.valueKind.allowBlank??!0)||!Ge(s)?A.ok():A.error({message:"Value missing",context:"ValueNode"}))}setOptions(e){const n=e.toSorted(),s=o(this.options);if(!me.isEqual(n,s)){this.options.set(n);const i=o(this.value);e.includes(i)||this.value.set("")}}clearOptions(){var n;(((n=o(this.options))==null?void 0:n.length)??0)!==0&&this.options.set(void 0)}reset(){this.value.set(""),this.clearOptions()}async toManifestString(){return`"${o(this.value)}"`}isEmbeddable(){return!0}initializeFromProgrammaticValue(e){this.value.set(e.value)}initializeFromPersistentValue(e){this.value.set(e.value)}toPersistableValue(){return{kind:"String",value:o(this.value)}}}const B=class B extends V{constructor(e,n){super(e,f({variant:e.variant,value:""}),n);u(this,"validationResult");this.validationResult=v(this.value,async s=>{if(s.value.trim()==="")return A.error({message:"Value missing",context:"ValueNode"});const i=s.variant;return i==null?A.error({message:"No NonFungibleLocalId variant selected",context:"ValueNode"}):He(i,s.value)})}reset(){this.value.set({variant:this.valueKind.variant,value:""})}async toManifestString(){return`NonFungibleLocalId("${B.mapNonFungibleLocalIdToString(o(this.value))}")`}static mapNonFungibleLocalIdToString(e){const[n,s]=e.variant?B.variantAffixes[e.variant]:["?","?"];return`${n}${e.value}${s}`}static parseTypeAndValue(e){const n=e[0],s=e.slice(1,-1);switch(n){case"<":return["String",s];case"#":return["Integer",s];case"[":return["Bytes",s];case"{":return["Ruid",s];default:throw new Error(`Invalid NonFungibleLocalId prefix: ${n}`)}}initializeFromProgrammaticValue(e,n){const[s,i]=B.parseTypeAndValue(e.value);this.value.set({variant:s,value:i})}initializeFromPersistentValue(e){this.value.set({value:e.value,variant:e.variant})}toPersistableValue(){const e=o(this.value);return{kind:"NonFungibleLocalId",value:e.value,variant:e.variant}}};u(B,"variantAffixes",{String:["<",">"],Integer:["#","#"],Bytes:["[","]"],Ruid:["{","}"]});let J=B;function Vt(a,t){const e=se(),n=Rt(a,t,e);return[e,n]}async function Rt(a,t,e){const n=new Pe(e);n.label.set(t);const s=a.instructions;if(s.kind!=="Parsed")throw new Error("Manifest required to be in parsed form");const i=new It;for(let r=0;r<s.value.length;r++){const l=s.value[r],d=yt(l),c=n.insertNewInstruction(r);c.command.set(d),await Ot(l,c,i)}return n}async function Ot(a,t,e){const n=o(t.fixedArgs);function s(i){return n[i].value.currentValueNode()}switch(a.kind){case"TakeAllFromWorktop":s(0).value.set(a.resourceAddress),s(1).value.set(e.idForNewlyProducedOwnable("Bucket"));break;case"TakeFromWorktop":s(0).value.set(a.resourceAddress),s(1).initializeFromDecimal(a.amount),s(2).value.set(e.idForNewlyProducedOwnable("Bucket"));break;case"TakeNonFungiblesFromWorktop":s(0).value.set(a.resourceAddress),re(s(1),a.ids),s(2).value.set(e.idForNewlyProducedOwnable("Bucket"));break;case"ReturnToWorktop":s(0).value.set(e.idForExistingOwnable("Bucket",a.bucketId));break;case"AssertWorktopContainsAny":s(0).value.set(a.resourceAddress);break;case"AssertWorktopContains":s(0).value.set(a.resourceAddress),s(1).initializeFromDecimal(a.amount);break;case"AssertWorktopContainsNonFungibles":s(0).value.set(a.resourceAddress),re(s(1),a.ids);break;case"PopFromAuthZone":s(0).value.set(e.idForNewlyProducedOwnable("Proof"));break;case"PushToAuthZone":s(0).value.set(e.idForExistingOwnable("Proof",a.proofId));break;case"DropAuthZoneProofs":break;case"CreateProofFromAuthZoneOfAmount":s(0).value.set(a.resourceAddress),s(1).initializeFromDecimal(a.amount),s(2).value.set(e.idForNewlyProducedOwnable("Proof"));break;case"CreateProofFromAuthZoneOfNonFungibles":s(0).value.set(a.resourceAddress),re(s(1),a.ids),s(2).value.set(e.idForNewlyProducedOwnable("Proof"));break;case"CreateProofFromAuthZoneOfAll":s(0).value.set(a.resourceAddress),s(1).value.set(e.idForNewlyProducedOwnable("Proof"));break;case"DropNamedProofs":break;case"DropAuthZoneRegularProofs":break;case"DropAuthZoneSignatureProofs":break;case"CreateProofFromBucketOfAmount":s(0).value.set(e.idForExistingOwnable("Bucket",a.bucketId)),s(1).initializeFromDecimal(a.amount),s(2).value.set(e.idForNewlyProducedOwnable("Proof"));break;case"CreateProofFromBucketOfNonFungibles":s(0).value.set(e.idForExistingOwnable("Bucket",a.bucketId)),re(s(1),a.ids),s(2).value.set(e.idForNewlyProducedOwnable("Proof"));break;case"CreateProofFromBucketOfAll":s(0).value.set(e.idForExistingOwnable("Bucket",a.bucketId)),s(1).value.set(e.idForNewlyProducedOwnable("Proof"));break;case"BurnResource":s(0).value.set(e.idForExistingOwnable("Bucket",a.bucketId));break;case"CloneProof":s(0).value.set(e.idForExistingOwnable("Proof",a.proofId)),s(1).value.set(e.idForNewlyProducedOwnable("Proof"));break;case"DropProof":s(0).value.set(e.idForExistingOwnable("Proof",a.proofId));break;case"CallFunction":if(s(0).value.set(Ae(a.packageAddress,e)),s(1).value.set(a.blueprintName),s(2).value.set(a.functionName),a.args.kind!==L.Tuple)throw new Error(`Invalid args kind: ${a.args.kind}`);await oe(t,a.args.fields,e);break;case"CallMethod":if(s(0).value.set(Ae(a.address,e)),s(1).value.set(a.methodName),a.args.kind!==L.Tuple)throw new Error(`Invalid args kind: ${a.args.kind}`);await oe(t,a.args.fields,e);break;case"CallRoyaltyMethod":case"CallMetadataMethod":case"CallRoleAssignmentMethod":if(s(0).value.set(Ae(a.address,e)),a.args.kind!==L.Tuple)throw new Error(`Invalid args kind: ${a.args.kind}`);await oe(t,a.args.fields,e);break;case"CallDirectVaultMethod":if(s(0).value.set(a.address),a.args.kind!==L.Tuple)throw new Error(`Invalid args kind: ${a.args.kind}`);await oe(t,a.args.fields,e);break;case"DropAllProofs":break;case"AllocateGlobalAddress":s(0).value.set(a.packageAddress),s(1).value.set(a.blueprintName),s(2).value.set(e.idForNewlyProducedOwnable("AddressReservation")),s(3).value.set(e.idForNewlyProducedOwnable("NamedAddress"));break;default:throw new Error(`Unhandled instruction kind: ${a.kind}`)}}function yt(a){if(a.kind==="CallRoyaltyMethod")switch(a.methodName){case"set_royalty":return"SET_COMPONENT_ROYALTY";case"lock_royalty":return"LOCK_COMPONENT_ROYALTY";case"claim_royalties":return"CLAIM_COMPONENT_ROYALTIES";default:throw new Error(`Unhandled CallRoyaltyMethod: ${a.methodName}`)}if(a.kind==="CallMetadataMethod")switch(a.methodName){case"set":return"SET_METADATA";case"lock":return"LOCK_METADATA";case"remove":return"REMOVE_METADATA";default:throw new Error(`Unhandled CallMetadataMethod: ${a.methodName}`)}if(a.kind==="CallRoleAssignmentMethod")switch(a.methodName){case"set":return"SET_ROLE";case"set_owner":return"SET_OWNER_ROLE";case"lock_owner":return"LOCK_OWNER_ROLE";default:throw new Error(`Unhandled CallRoleAssignmentMethod: ${a.methodName}`)}if(a.kind==="CallDirectVaultMethod")switch(a.methodName){case"freeze":return"FREEZE_VAULT";case"unfreeze":return"UNFREEZE_VAULT";case"recall":return a.args.kind==="Tuple"&&a.args.fields[0].kind==="Decimal"?"RECALL_FROM_VAULT":"RECALL_NON_FUNGIBLE";default:throw new Error(`Unhandled CallRoleAssignmentMethod: ${a.methodName}`)}return wt[a.kind]}const wt={TakeAllFromWorktop:"TAKE_ALL_FROM_WORKTOP",TakeFromWorktop:"TAKE_FROM_WORKTOP",TakeNonFungiblesFromWorktop:"TAKE_NON_FUNGIBLES_FROM_WORKTOP",ReturnToWorktop:"RETURN_TO_WORKTOP",AssertWorktopContainsAny:"ASSERT_WORKTOP_CONTAINS_ANY",AssertWorktopContains:"ASSERT_WORKTOP_CONTAINS",AssertWorktopContainsNonFungibles:"ASSERT_WORKTOP_CONTAINS_NON_FUNGIBLES",PopFromAuthZone:"POP_FROM_AUTH_ZONE",PushToAuthZone:"PUSH_TO_AUTH_ZONE",DropAuthZoneProofs:"DROP_AUTH_ZONE_PROOFS",CreateProofFromAuthZoneOfAmount:"CREATE_PROOF_FROM_AUTH_ZONE_OF_AMOUNT",CreateProofFromAuthZoneOfNonFungibles:"CREATE_PROOF_FROM_AUTH_ZONE_OF_NON_FUNGIBLES",CreateProofFromAuthZoneOfAll:"CREATE_PROOF_FROM_AUTH_ZONE_OF_ALL",DropNamedProofs:"DROP_NAMED_PROOFS",DropAuthZoneRegularProofs:"DROP_AUTH_ZONE_REGULAR_PROOFS",DropAuthZoneSignatureProofs:"DROP_AUTH_ZONE_SIGNATURE_PROOFS",CreateProofFromBucketOfAmount:"CREATE_PROOF_FROM_BUCKET_OF_AMOUNT",CreateProofFromBucketOfNonFungibles:"CREATE_PROOF_FROM_BUCKET_OF_NON_FUNGIBLES",CreateProofFromBucketOfAll:"CREATE_PROOF_FROM_BUCKET_OF_ALL",BurnResource:"BURN_RESOURCE",CloneProof:"CLONE_PROOF",DropProof:"DROP_PROOF",CallFunction:"CALL_FUNCTION",CallMethod:"CALL_METHOD",CallRoyaltyMethod:"CALL_ROYALTY_METHOD",CallMetadataMethod:"CALL_METADATA_METHOD",CallRoleAssignmentMethod:"CALL_ROLE_ASSIGNMENT_METHOD",CallDirectVaultMethod:"CALL_DIRECT_VAULT_METHOD",DropAllProofs:"DROP_ALL_PROOFS",AllocateGlobalAddress:"ALLOCATE_GLOBAL_ADDRESS"};class It{constructor(){u(this,"ownValueCounts",new Map)}idForNewlyProducedOwnable(t){const e=this.ownValueCounts.get(t)??0;return this.ownValueCounts.set(t,e+1),`${t.toLowerCase()}_${e}`}idForExistingOwnable(t,e){return`${t.toLowerCase()}_${e}`}}function Ae(a,t){return a.kind==="Static"?a.value:t.idForExistingOwnable("NamedAddress",a.value)}function re(a,t){const e=a.value;for(const n of t){const[s,i]=J.parseTypeAndValue(n);o(e.insertNewElement().valueNode).value.set({variant:s,value:i})}}async function oe(a,t,e){const n=await o(a.variableArgs)??[];for(let s=0;s<t.length;s++){const i=t[s];(n[s]??a.addArgument(G(i.kind,"consumes"))).value.initializeFromProgrammaticValue(i,e)}}function j(a,t){return a==="Bucket"||a==="Proof"||a==="NamedAddress"||a==="AddressReservation"?{kind:a,mode:t}:{kind:a}}class K extends V{constructor(e,n){var s,i;super(e,K.createNewCompositeValue(e,n),n);u(this,"canBeReplacedWithExpressionEntireWorktop");u(this,"canBeReplacedWithExpressionEntireAuthZone");u(this,"replaceWithExpressionInitial");u(this,"replaceWithExpression");u(this,"validationResult");this.canBeReplacedWithExpressionEntireWorktop=e.kind==="Array"&&((s=e.valuesKind)==null?void 0:s.kind)==="Bucket",this.canBeReplacedWithExpressionEntireAuthZone=e.kind==="Array"&&((i=e.valuesKind)==null?void 0:i.kind)==="Proof",this.replaceWithExpressionInitial=this.canBeReplacedWithExpressionEntireWorktop||this.canBeReplacedWithExpressionEntireAuthZone,this.replaceWithExpression=f(this.replaceWithExpressionInitial),this.replaceWithExpression.subscribe(r=>{r&&this.value.reset()}),this.validationResult=this.value.validationResult,this.consumedInputs=this.value.consumedInputs}get canBeReplacedWithExpression(){return this.canBeReplacedWithExpressionEntireWorktop||this.canBeReplacedWithExpressionEntireAuthZone}static createNewCompositeValue(e,n){if(e.kind==="Array")return new _t(e,n);if(e.kind==="Map")return new Tt(e,n);if(e.kind==="Tuple")return new Mt(e,n);if(e.kind==="Enum")return new Ct(e,n);throw new Error("Unhandled value kind: "+e)}reset(){this.replaceWithExpression.set(this.replaceWithExpressionInitial),this.value=K.createNewCompositeValue(this.valueKind,this.instruction)}async toManifestString(){if(o(this.replaceWithExpression)){if(this.canBeReplacedWithExpressionEntireWorktop)return'Expression("ENTIRE_WORKTOP")';if(this.canBeReplacedWithExpressionEntireAuthZone)return'Expression("ENTIRE_AUTH_ZONE")'}return this.value.toManifestString()}isEmbeddable(){var e,n;return this.valueKind.kind==="Tuple"&&((n=(e=this.valueKind)==null?void 0:e.elementKinds)==null?void 0:n.length)===1&&this.value.isEmbeddable()}initializeFromProgrammaticValue(e,n){e.kind==="Expression"?this.replaceWithExpression.set(!0):(this.replaceWithExpression.set(!1),this.value.initializeFromProgrammaticValue(e,n))}initializeFromPersistentValue(e){e.replaceWithExpression?this.replaceWithExpression.set(!0):(this.replaceWithExpression.set(!1),this.value.initializeFromPersistentValue(e))}toPersistableValue(){return o(this.replaceWithExpression)?{kind:"Array",replaceWithExpression:!0,valuesKind:this.canBeReplacedWithExpressionEntireWorktop?"Bucket":"Proof"}:{...this.value.toPersistableValue(),replaceWithExpression:!1}}getChildValueNodes(){return this.value.getChildValueNodes().flatMap(n=>[n,...n.getChildValueNodes()])}}class _t{constructor(t,e){u(this,"valuesKind");u(this,"values");u(this,"typeNameWithGenerics");u(this,"validationResult");u(this,"consumedInputs");this.valueKind=t,this.instruction=e,this.valuesKind=f(t.valuesKind?z(t.valuesKind,"consumes"):void 0),this.values=f([]),this.typeNameWithGenerics=v(this.valuesKind,s=>{const i=pe(s);return`Array<${(i==null?void 0:i.kind)??"?"}>`});const n=X(this.values,s=>s.map(i=>i.validationResult));this.validationResult=v([this.valuesKind,n],async([s,i])=>de(s)?A.error({message:"Array type missing",context:"ValueNode"}):i),this.consumedInputs=v(Q(this.values,s=>Z(s.flatMap(i=>i.consumedInputs))),W.flatten)}size(){return v(this.values,t=>t.length)}reset(){this.valuesKind.set(this.valueKind.valuesKind),this.values.set([])}async toManifestString(){let t=o(this.values);const e=o(this.valuesKind),n=(e&&Ke(e))??!1;let s=(await Promise.all(t.map(async i=>n?i.toManifestString():ee(await i.toManifestString(),te)))).join(n?", ":`,
`);return!n&&t.length>0&&(s=`
${s}
`),`${o(this.typeNameWithGenerics)}(${s})`}insertNewElement(){const t=o(this.valuesKind);if(t==null)throw new Error("Cannot create a new array element when the element kind is unknown");const e=R(t,this.instruction);return this.values.set([...o(this.values),e]),e}initializeFromProgrammaticValue(t,e){this.reset(),this.valuesKind.set(G(t.elementValueKind,"consumes"));for(const n of t.elements)this.insertNewElement().initializeFromProgrammaticValue(n,e)}initializeFromPersistentValue(t){this.valuesKind.set({kind:t.valuesKind});for(const e of t.values)this.insertNewElement().initializeFromPersistentValue(e)}toPersistableValue(){var t;return{kind:"Array",valuesKind:((t=o(this.valuesKind))==null?void 0:t.kind)??"Any",values:o(this.values).map(e=>e.toPersistableValue())}}getChildValueNodes(){return o(this.values).map(t=>t.currentValueNode())}}class Tt{constructor(t,e){u(this,"keysKind");u(this,"valuesKind");u(this,"entries");u(this,"typeNameWithGenerics");u(this,"validationResult");u(this,"consumedInputs");this.valueKind=t,this.instruction=e,this.keysKind=f(t.keysKind?z(t.keysKind,"consumes"):void 0),this.valuesKind=f(t.valuesKind?z(t.valuesKind,"consumes"):void 0),this.entries=f([]),this.typeNameWithGenerics=v([this.keysKind,this.valuesKind],([s,i])=>{const r=pe(s),l=pe(i);return`Map<${(r==null?void 0:r.kind)??"?"}, ${(l==null?void 0:l.kind)??"?"}>`});const n=X(this.entries,s=>s.flatMap(i=>[i.key.validationResult,i.value.validationResult]));this.validationResult=v([this.keysKind,this.valuesKind,n],async([s,i,r])=>{const l=[];return de(s)&&l.push({message:"Key type missing",context:"ValueNode"}),de(i)&&l.push({message:"Value type missing",context:"ValueNode"}),new A([...l,...(await r).errors])}),this.consumedInputs=v(Q(this.entries,s=>s.flatMap(({key:i,value:r})=>Z([i.consumedInputs,r.consumedInputs]))),W.flatten)}size(){return v(this.entries,t=>t.length)}reset(){this.keysKind.set(this.valueKind.keysKind),this.valuesKind.set(this.valueKind.valuesKind),this.entries.set([])}async toManifestString(){const t=o(this.valuesKind),e=(t&&Ke(t))??!1;let n=(await Promise.all(o(this.entries).map(async({key:s,value:i})=>{let r=`${await s.toManifestString()} => ${await i.toManifestString()}`;return e?r:ee(r,te)}))).join(e?", ":`,
`);return e&&(n=`
${n}
`),`${o(this.typeNameWithGenerics)}(${n})`}insertNewEntry(){const t=o(this.keysKind),e=o(this.valuesKind);if(t==null||e==null)throw new Error("Cannot create a new map element when the keys or values kind is unknown");const n=R(t,this.instruction),s=R(e,this.instruction),i={key:n,value:s};return this.entries.set([...o(this.entries),i]),i}initializeFromProgrammaticValue(t,e){this.reset(),this.keysKind.set(G(t.keyValueKind,"consumes")),this.valuesKind.set(G(t.valueValueKind,"consumes"));for(const n of t.entries){const{key:s,value:i}=this.insertNewEntry();s.initializeFromProgrammaticValue(n.key,e),i.initializeFromProgrammaticValue(n.value,e)}}initializeFromPersistentValue(t){this.keysKind.set(j(t.keysKind,"consumes")),this.valuesKind.set(j(t.valuesKind,"consumes"));for(const e of t.entries){const{key:n,value:s}=this.insertNewEntry();n.initializeFromPersistentValue(e.key),s.initializeFromPersistentValue(e.value)}}toPersistableValue(){var t,e;return{kind:"Map",keysKind:((t=o(this.keysKind))==null?void 0:t.kind)??"Any",valuesKind:((e=o(this.valuesKind))==null?void 0:e.kind)??"Any",entries:o(this.entries).map(({key:n,value:s})=>({key:n.toPersistableValue(),value:s.toPersistableValue()}))}}getChildValueNodes(){return o(this.entries).flatMap(({key:t,value:e})=>[t.currentValueNode(),e.currentValueNode()])}}class Mt{constructor(t,e){u(this,"values");u(this,"typeNameWithGenerics",ue(f("Tuple")));u(this,"elementKinds");u(this,"elementNames");u(this,"validationResult");u(this,"consumedInputs");var s;this.instruction=e;const n=(s=t.elementKinds)==null?void 0:s.map(i=>R(i,e));this.values=f(n??[]),this.elementKinds=ue(f(t.elementKinds)),this.elementNames=ue(f(t.elementNames)),this.validationResult=X(this.values,i=>i.map(r=>r.validationResult)),this.consumedInputs=v(Q(this.values,i=>Z(i.flatMap(r=>r.consumedInputs))),W.flatten)}size(){return v(this.values,t=>t.length)}reset(){o(this.values).forEach(t=>t.currentValueNode().reset())}async toManifestString(){let t=o(this.values),e=(await Promise.all(t.map(async n=>ee(await n.toManifestString(),te)))).join(`,
`);return t.length>0&&(e=`
${e}
`),`${o(this.typeNameWithGenerics)}(${e})`}isEmbeddable(){var t;return(t=o(this.values)[0])==null?void 0:t.isEmbeddable()}initializeFromProgrammaticValue(t,e){const n=o(this.values),s=t.fields;for(let i=0;i<s.length;i++){const r=s[i];(n[i]??this.addNewValue(G(r.kind,"consumes"),!0)).initializeFromProgrammaticValue(r,e)}}initializeFromPersistentValue(t){const e=o(this.values),n=t.values;for(let s=0;s<n.length;s++){const i=n[s];(e[s]??this.addNewValue(j(i.kind,"consumes"),!0)).initializeFromPersistentValue(i)}}addNewValue(t,e){const n=R(t,this.instruction,e);return this.values.update(s=>(s.push(n),s)),n}toPersistableValue(){return{kind:"Tuple",values:o(this.values).map(t=>t.toPersistableValue())}}getChildValueNodes(){return o(this.values).map(t=>t.currentValueNode())}}class Ct{constructor(t,e){u(this,"discriminatorValue");u(this,"values");u(this,"typeNameWithGenerics");u(this,"elementKinds");u(this,"elementNames");u(this,"validationResult");u(this,"consumedInputs");this.instruction=e,this.discriminatorValue=f(void 0),this.values=f(n(o(this.discriminatorValue)??-1)??[]),this.typeNameWithGenerics=v(this.discriminatorValue,i=>{const r=i==null?void 0:i.toString();return`Enum<${Ze(r,"?")}u8>`}),this.elementKinds=v(this.discriminatorValue,i=>{var l;const r=(l=t.variants)==null?void 0:l.get(i??-1);return r==null?void 0:r.elementKinds}),this.elementNames=v(this.discriminatorValue,i=>{var l;const r=(l=t.variants)==null?void 0:l.get(i??-1);return r==null?void 0:r.elementNames}),this.discriminatorValue.subscribe(i=>{const r=n(i??-1);r!==void 0&&this.values.set(r)});function n(i){var l,d;const r=(l=t.variants)==null?void 0:l.get(i);return(d=r==null?void 0:r.elementKinds)==null?void 0:d.map(c=>R(c,e))}const s=X(this.values,i=>i.map(r=>r.validationResult));this.validationResult=v([this.discriminatorValue,s],async([i,r])=>{if(de(i))return A.error({message:"Enum variant not selected",context:"ValueNode"});const d=(await Promise.all(o(this.values).map(c=>o(c.validationResult)))).flatMap(c=>c.errors);return new A(d)}),this.consumedInputs=v(Q(this.values,i=>Z(i.flatMap(r=>r.consumedInputs))),W.flatten)}size(){return v(this.values,t=>t.length)}reset(){this.discriminatorValue.set(void 0),this.values.set([])}async toManifestString(){const t=o(this.values);let e=(await Promise.all(t.map(async n=>ee(await n.toManifestString(),te)))).join(`,
`);return t.length>0&&(e=`
${e}
`),`${o(this.typeNameWithGenerics)}(${e})`}initializeFromProgrammaticValue(t,e){this.discriminatorValue.set(t.discriminator);const n=o(this.values),s=t.fields;for(let i=0;i<s.length;i++){const r=s[i];(n[i]??this.addNewValue(G(r.kind,"consumes"),!0)).initializeFromProgrammaticValue(r,e)}}initializeFromPersistentValue(t){this.discriminatorValue.set(t.discriminatorValue);const e=o(this.values),n=t.values;for(let s=0;s<n.length;s++){const i=n[s];(e[s]??this.addNewValue(j(i.kind,"consumes"),!0)).initializeFromPersistentValue(i)}}addNewValue(t,e){const n=R(t,this.instruction,e);return this.values.update(s=>(s.push(n),s)),n}toPersistableValue(){return{kind:"Enum",discriminatorValue:o(this.discriminatorValue),values:o(this.values).map(t=>t.toPersistableValue())}}getChildValueNodes(){return o(this.values).map(t=>t.currentValueNode())}}function Ke(a){return new Set(["Bool","I8","I16","I32","I64","U8","U16","U32","U64","String"]).has(a.kind)}async function ss(a){const t=await w.ManifestSbor.decodeToString(a,I,_e.ManifestString),s={kind:"String",value:`
            CALL_FUNCTION
              Address("${(await w.Utils.knownAddresses(I)).packageAddresses.packagePackage}")
              "Package"
              "publish_wasm"
              ${t}
              Bytes("")
              Map<String, Tuple>()
            ;
        `},i=await w.Instructions.convert(s,I,"Parsed");if(i.kind!=="Parsed")throw new Error("Unreachable");const r=i.value[0];if(r.kind!=="CallFunction")throw new Error("Unreachable");if(r.args.kind!==L.Tuple)throw new Error("Unreachable");return r.args.fields[0]}class St extends V{constructor(e,n){super(e,f(""),n);u(this,"validationResult");u(this,"availableNamedAddresses",v(this.instruction.inputs,e=>e.filter(n=>n.kind==="NamedAddress")));u(this,"isValueNamedAddress",v([this.value,ce(this.instruction.inputs)],([e,n])=>n.find(s=>s.kind==="NamedAddress"&&s.name===e)!==void 0));u(this,"validStaticOrNamedAddress");this.validStaticOrNamedAddress=v([this.value,this.instruction.inputs],async([s,i])=>{var l;const r=i.find(d=>d.kind==="AddressReservation"&&d.namedAddressName===s);if((r==null?void 0:r.kind)==="AddressReservation"&&r.namedAddressName)return{kind:"named",addressName:r.namedAddressName,addressReservationName:r.name,packageAddress:r.packageAddress,blueprintName:r.blueprintName};try{const{networkId:d,entityType:c}=await w.Address.decode(s),m=$e(c);return d!==I||(l=this.valueKind.variants)!=null&&l.length&&!this.valueKind.variants.includes(m)?void 0:{kind:"static",address:s,entityVariant:m}}catch{return}}),this.validStaticOrNamedAddress.subscribe(async s=>{const i=await s;(i==null?void 0:i.kind)==="static"&&await ne.useEntity(i.address)}),this.validationResult=Ye([this.value,this.isValueNamedAddress],async([s,i])=>((s==null?void 0:s.trim())??"")===""?A.error({message:"Value missing",context:"ValueNode"}):i?A.ok():we(s,this.valueKind.variants))}reset(){this.value.set("")}async toManifestString(){var n;return((n=await o(this.validStaticOrNamedAddress))==null?void 0:n.kind)==="named"?`NamedAddress("${o(this.value)}")`:`Address("${o(this.value)}")`}isEmbeddable(){return!0}initializeFromProgrammaticValue(e,n){const s=e.value;s.kind==="Static"?this.value.set(s.value):this.value.set(n.idForExistingOwnable("NamedAddress",s.value))}initializeFromPersistentValue(e){this.value.set(e.value)}toPersistableValue(){return{kind:"Address",value:o(this.value)}}}class le extends V{constructor(e,n){super(e,f(""),n);u(this,"validationResult");u(this,"selectableInputs");this.selectableInputs=v(this.instruction.inputs,s=>s.filter(i=>{const r=e.kind;return i.kind===r&&!i.isConsumed})),this.validationResult=v([this.value,n.inputs,n.manifestNode.danglingOutputs,n.argConsumedInputs],async([s,i,r,l])=>{const d=this.valueKind.kind,c=d==="Bucket"||d==="Proof"?this.valueKind.variant:void 0,m=d==="Bucket"||d==="Proof"?`${this.valueKind.variant??""}${d}`:d;if(s)if(this.valueKind.mode==="consumes"||this.valueKind.mode==="inert"){const h=i.find(N=>N.kind===d&&N.name===s),p=(h==null?void 0:h.kind)==="Bucket"||(h==null?void 0:h.kind)==="Proof"?await h.resourceVariant:void 0;return h?c&&p&&c!==p?A.error({message:`Requires a ${m} but ${d} ${s} is ${p}`,context:"ValueNode"}):h.isConsumed?A.error({message:`${m} ${s} is already consumed by another instruction`,context:"ValueNode"}):l.filter(b=>b.kind===d&&b.name===s).length>1?A.error({message:`${m} ${s} cannot be consumed multiple times`,context:"ValueNode"}):A.ok():A.error({message:`A ${m} with name ${s} is not defined`,context:"ValueNode"})}else return this.valueKind.mode==="produces"?i.find(N=>N.kind===d&&N.name===s)!=null?A.error({message:`A ${m} with name ${s} is already defined`,context:"ValueNode"}):r.find(N=>N.kind===d&&N.name===s)?A.error({message:`${m} ${s} is dangling`,context:"ValueNode"}):A.ok():A.ok();else return this.valueKind.mode==="produces"?A.error({message:"Identifier missing",context:"ValueNode"}):A.error({message:`${this.valueKind.kind} missing`,context:"ValueNode"})}),this.consumedInputs=v(this.value,s=>this.valueKind.mode==="consumes"?[{kind:this.valueKind.kind,name:s}]:[])}reset(){const e=o(this.value);me.isEqual(e,"")||this.value.set("")}async toManifestString(){return`${this.valueKind.kind}("${o(this.value)}")`}isEmbeddable(){return!0}initializeFromProgrammaticValue(e,n){if(e.kind==="Bucket"?this.value.set(n.idForExistingOwnable("Bucket",e.value)):e.kind==="Proof"&&this.value.set(n.idForExistingOwnable("Proof",e.value)),e.kind==="AddressReservation"&&this.value.set(n.idForExistingOwnable("AddressReservation",e.value)),e.kind==="Address"){const s=e.value;if(s.kind!=="Named")throw new Error("Expected a named address");this.value.set(n.idForExistingOwnable("NamedAddress",s.value))}}initializeFromPersistentValue(e){this.value.set(e.value)}toPersistableValue(){return{kind:this.valueKind.kind,value:o(this.value)}}}class Kt extends V{constructor(e,n){super(e,f(""),n);u(this,"validationResult");this.validationResult=v(this.value,async s=>{const i=["ENTIRE_WORKTOP","ENTIRE_AUTH_ZONE"];return i.includes(s)?A.ok():A.error({message:"Value must be one of "+i.join(", "),context:"ValueNode"})})}reset(){this.value.set("")}async toManifestString(){return`Expression("${o(this.value)}")`}isEmbeddable(){return!0}initializeFromProgrammaticValue(e,n){this.value.set(e.value)}initializeFromPersistentValue(e){this.value.set(e.value)}toPersistableValue(){return{kind:"Expression",value:o(this.value)}}}class H extends V{constructor(e,n){super(e,f(H.createEmptyValueForType(e.kind)),n);u(this,"allowedActualKinds");u(this,"validationResult");this.allowedActualKinds=e.kind==="Bytes"?["Bytes","Blob"]:["Blob"],this.validationResult=v(this.value,async s=>{var r;const i=this.valueKind.kind==="Bytes"?this.valueKind.length:void 0;return s.kind==="Bytes"?this.validateBytesValue(s.dataHex,i):s.kind==="Blob"?this.validateBlobValue((r=s.data)==null?void 0:r.data,i):A.error({message:"File missing",context:"ValueNode"})})}validateBytesValue(e,n){return e?n!==void 0&&e.length!==n*2?A.error({message:`Invalid length: expected ${n} bytes resp. ${n*2} hex digits but found ${e.length} hex digits`,context:"ValueNode"}):Je.test(e)?A.ok():A.error({message:"Invalid bytes hex string",context:"ValueNode"}):A.error({message:"Value missing",context:"ValueNode"})}validateBlobValue(e,n){return e==null?A.error({message:"Value missing",context:"ValueNode"}):n!==void 0&&e.length!==n?A.error({message:`Invalid length: expected ${n} bytes but found ${e.length}`,context:"ValueNode"}):A.ok()}reset(){this.reinitializeValueForType("Bytes")}reinitializeValueForType(e){this.value.set(H.createEmptyValueForType(e))}static createEmptyValueForType(e){return e==="Bytes"?{kind:"Bytes",dataHex:""}:{kind:"Blob",data:void 0}}async toManifestString(){var n;const e=o(this.value);return e.kind==="Bytes"?`Bytes("${e.dataHex}")`:e.kind==="Blob"?`Blob("${((n=e.data)==null?void 0:n.dataHash)??""}")`:`Blob("${e.dataHash}")`}isEmbeddable(){return!1}initializeFromProgrammaticValue(e,n){if(e.kind==="Blob")this.value.set({kind:"ImportedBlob",dataHash:je(e.value)});else{const s=e.elements.map(i=>{if(i.kind!==L.U8)throw new Error("Invalid case");return i.value.toString(16).padStart(2,"0")}).join("");this.value.set({kind:"Bytes",dataHex:s})}}initializeFromPersistentValue(e){this.value.set(e.value)}toPersistableValue(){var s;const e=o(this.value);let n;switch(e.kind){case"Bytes":n=e;break;case"Blob":n={kind:"ImportedBlob",dataHash:(s=e.data)==null?void 0:s.dataHash};break;case"ImportedBlob":n=e}return{kind:this.valueKind.kind,value:n}}}class Re extends V{constructor(e,n){super(e,f(""),n);u(this,"validationResult");this.validationResult=v(this.value,async s=>s?(this.valueKind.kind==="Decimal"?qe:Xe).validate(s):A.error({message:"Value missing",context:"ValueNode"}))}reset(){this.value.set("")}async toManifestString(){return`${this.valueKind.kind}("${o(this.value)}")`}isEmbeddable(){return!0}initializeFromProgrammaticValue(e){this.initializeFromDecimal(e.value)}initializeFromDecimal(e){this.value.set(Qe(e))}initializeFromPersistentValue(e){this.value.set(e.value)}toPersistableValue(){return{kind:this.valueKind.kind,value:o(this.value)}}}class ke extends V{constructor(e,n){super(e,ke.createValue(n),n);u(this,"validationResult");this.value.address.value.subscribe(async s=>{const i=o(this.value.address.value),r=await ne.useEntity(i);if(r){const l=r.details,d=o(this.value.nonFungibleLocalId.value);d.variant=l.nonFungibleIdType,this.value.nonFungibleLocalId.value.set(d),this.value.nonFungibleIdVariantSelectable.set(!1)}else this.value.nonFungibleIdVariantSelectable.set(!0)}),this.validationResult=v([this.value.address.validationResult,this.value.nonFungibleLocalId.validationResult],async([s,i])=>new A([...(await s).errors,...(await i).errors]))}reset(){this.value.nonFungibleLocalId.reset(),this.value.address.reset(),this.value.nonFungibleIdVariantSelectable.set(!0)}static createValue(e){const n=o(R({kind:"Address",variants:["NonFungibleResource"]},e).valueNode),s=o(R({kind:"NonFungibleLocalId"},e).valueNode);return{address:n,nonFungibleLocalId:s,nonFungibleIdVariantSelectable:f(!0)}}async toManifestString(){const e=o(this.value.address.value),n=J.mapNonFungibleLocalIdToString(o(this.value.nonFungibleLocalId.value));return`NonFungibleGlobalId("${e}:${n}")`}initializeFromProgrammaticValue(e,n){const s=e.fields[0],i=e.fields[1];if(s.kind!=="Address"||i.kind!=="NonFungibleLocalId")throw new Error("Invalid value kinds");this.value.address.initializeFromProgrammaticValue(s,n),this.value.nonFungibleLocalId.initializeFromProgrammaticValue(i,n)}initializeFromPersistentValue(e){this.value.address.initializeFromPersistentValue(e.addressValue),this.value.nonFungibleLocalId.initializeFromPersistentValue(e.nonFungibleLocalIdValue)}toPersistableValue(){return{kind:"NonFungibleGlobalId",addressValue:this.value.address.toPersistableValue(),nonFungibleLocalIdValue:this.value.nonFungibleLocalId.toPersistableValue()}}}class xt{constructor(t){u(this,"fixedValueNode");u(this,"valueKind");u(this,"valueNode");u(this,"validationResult");u(this,"consumedInputs");this.fixedValueNode=t,this.valueKind=U(t.valueKind),this.valueNode=U(t),this.validationResult=t.validationResult,this.consumedInputs=t.consumedInputs}currentValueNode(){return this.fixedValueNode}toManifestString(){return o(this.valueNode).toManifestString()}getChildValueNodes(){return o(this.valueNode).getChildValueNodes()}toPersistableValue(){return o(this.valueNode).toPersistableValue()}initializeFromProgrammaticValue(t,e){o(this.valueNode).initializeFromProgrammaticValue(t,e)}initializeFromPersistentValue(t){o(this.valueNode).initializeFromPersistentValue(t)}isEmbeddable(){return o(this.valueNode).isEmbeddable()}}class Dt{constructor(t,e){u(this,"valueKind");u(this,"valueNode");u(this,"validationResult");u(this,"consumedInputs");this.instructionNode=t,this.valueKind=f(e),this.valueNode=f(this.deriveValueNodeFromValueKind(e,t)),this.validationResult=Fe(this.valueNode,n=>n.validationResult),this.consumedInputs=Fe(this.valueNode,n=>n.consumedInputs??U([]))}deriveValueNodeFromValueKind(t,e){return z(t,"consumes").kind!=="Any"?xe(t,e):new Se(e)}setValueKind(t){E(this.valueKind).set(t),E(this.valueNode).set(this.deriveValueNodeFromValueKind(t,this.instructionNode))}currentValueNode(){return o(this.valueNode)}toManifestString(){return o(this.valueNode).toManifestString()}getChildValueNodes(){return o(this.valueNode).getChildValueNodes()}toPersistableValue(){return o(this.valueNode).toPersistableValue()}initializeFromProgrammaticValue(t,e){o(this.valueNode).initializeFromProgrammaticValue(t,e)}initializeFromPersistentValue(t){o(this.valueNode).initializeFromPersistentValue(t)}isEmbeddable(){return!1}}class Lt{constructor(t){u(this,"command",f(void 0));u(this,"enabled",f(!0));u(this,"fixedArgs",f([]));u(this,"variableArgs",f(Promise.resolve(void 0)));u(this,"manuallyAddedArgs",f([]));u(this,"args",v([this.fixedArgs,this.variableArgs,this.manuallyAddedArgs],async([t,e,n])=>{const s=await e;return s!==void 0?[...t,...s]:[...t,...n]}));u(this,"inputs",f([]));u(this,"outputs",f([]));u(this,"upstreamOutputsUnsubscriber");u(this,"consumableFilter");u(this,"instructionAdvisor");u(this,"variableArgDefinitionsProviderUnsubscriber");u(this,"id");u(this,"previousVariableArgDefs");u(this,"previousVariableArgs");u(this,"unsubscribes",[]);u(this,"validationResult");u(this,"argConsumedInputs");this.manifestNode=t,this.id=se();const e=v([this.variableArgs,this.manuallyAddedArgs],async([i,r])=>{const l=await i;return l??r});this.argConsumedInputs=ce(v(Q(ye(e,[]),i=>Z(i.map(r=>r.value.consumedInputs))),W.flatten)),this.unsubscribes.push(this.command.subscribe(i=>{var d,c;if(!i)return;const l=g.lookupInstructionDefinition(i).args.map(m=>this.createInstructionArgument(m));this.fixedArgs.set(l),this.variableArgs.set(Promise.resolve(void 0)),(d=this.instructionAdvisor)==null||d.unsubscribe(),(c=this.variableArgDefinitionsProviderUnsubscriber)==null||c.call(this)})),this.unsubscribes.push(v([this.command,this.fixedArgs],D).subscribe(([i,r])=>{var m;if((m=this.variableArgDefinitionsProviderUnsubscriber)==null||m.call(this),!i)return;const d=g.lookupInstructionDefinition(i).variableArgDefinitionsProvider,c=d?new d().getVariableArgDefinitions(this):void 0;this.variableArgDefinitionsProviderUnsubscriber=c==null?void 0:c.subscribe(h=>{const p=h.then(N=>{if(W.isEqual(N,this.previousVariableArgDefs))return this.previousVariableArgs;{this.previousVariableArgDefs=N;const b=N==null?void 0:N.map(k=>this.createInstructionArgument(k));return this.previousVariableArgs=b,b}});this.variableArgs.set(p)})}));let n;this.unsubscribes.push(v([this.command,this.enabled],D).subscribe(async([i,r])=>{var c,m,h;(c=this.consumableFilter)==null||c.unsubscribe(),(m=this.instructionAdvisor)==null||m.unsubscribe(),(h=this.variableArgDefinitionsProviderUnsubscriber)==null||h.call(this);const l=`${i}-${r}`;if(l===n)return;n=l;let d;if(i&&r){const p=g.lookupInstructionDefinition(i),N=p.consumableFilter;d=N?new N:new Ve;const b=p.instructionAdvisor,k=b?new b:void 0;k==null||k.subscribe(this),this.instructionAdvisor=k}else d=new Ve;d==null||d.subscribe(this.inputs,this.outputs,this),this.consumableFilter=d}));const s=et(this.args,i=>i.map(r=>r.value.validationResult));this.validationResult=v([this.command,s],async([i,r])=>i?r:A.error({message:"Instruction command missing",context:"InstructionNode"}))}addArgument(t){const n=`arg #${o(this.manuallyAddedArgs).length}`,s={value:R(t,this,!0),name:n};return this.manuallyAddedArgs.update(i=>(i.push(s),i)),s}removeArgumentAt(t){this.manuallyAddedArgs.update(e=>(e.splice(t,1),e))}createInstructionArgument(t){return{value:R(t.valueKind,this),name:t.name}}async toManifestString(){const t=o(this.command),e=await o(this.args),n=(await Promise.all(e.map(async i=>{const r=await i.value.toManifestString();return`
${ee(r,te)}`}))).join(""),s=e.length===0?";":`
;`;return t+n+s}async getAllValueNodes(){const e=(await o(this.args)).map(s=>o(s.value.valueNode)),n=e.flatMap(s=>s.getChildValueNodes());return[...e,...n]}setUpstreamOutputs(t){var e;(e=this.upstreamOutputsUnsubscriber)==null||e.call(this),this.upstreamOutputsUnsubscriber=t.subscribe(n=>{const s=o(this.inputs);me.isEqual(n,s)||this.inputs.set(n)})}unsubscribeAll(){var t,e,n,s;this.unsubscribes.forEach(i=>i()),(t=this.upstreamOutputsUnsubscriber)==null||t.call(this),(e=this.variableArgDefinitionsProviderUnsubscriber)==null||e.call(this),(n=this.instructionAdvisor)==null||n.unsubscribe(),(s=this.consumableFilter)==null||s.unsubscribe()}async toPersistableInstruction(){const t=(await o(this.args)).map(e=>({value:e.value.toPersistableValue(),name:e.name}));return{command:o(this.command),enabled:o(this.enabled),args:t}}}function pe(a,t="consumes"){if(a!==void 0)return a.kind==="LocalSchemaReference"?a.localSchemaReference.resolveToValueKind():a.kind==="WellKnownReference"?Ie(a.name,t):a}const Bt={Any:Se,Bool:Ft,I8:y,I16:y,I32:y,I64:y,I128:y,U8:y,U16:y,U32:y,U64:y,U128:y,String:Et,Tuple:K,Enum:K,Array:K,Map:K,Address:St,NamedAddress:le,AddressReservation:le,Bucket:le,Proof:le,Expression:Kt,Blob:H,Decimal:Re,PreciseDecimal:Re,NonFungibleLocalId:J,NonFungibleGlobalId:ke,Bytes:H,LocalSchemaReference:void 0,WellKnownReference:void 0};function R(a,t,e=!1){let n=z(a,"consumes");return n.kind!="Any"&&!e?new xt(xe(n,t)):new Dt(t,n)}function xe(a,t){if(a==null||a.kind==="Any")throw new Error(`Function createNewValueNode cannot be called with valueKind null or Any: ${a}`);let e=z(a,"consumes");const n=Bt[e.kind];if(n==null)throw new Error("No constructor found for value kind: "+e.kind);return Reflect.construct(n,[e,t])}class Pe{constructor(t=se()){u(this,"id");u(this,"label");u(this,"transactionMessage",f(""));u(this,"instructions",f([]));u(this,"enabledInstructions",Ut(this.instructions));u(this,"danglingOutputs",ce(v(this.instructions,(t,e)=>{const n=t[t.length-1];if(!n){e([]);return}return n.outputs.subscribe(s=>{const i=s.filter(r=>(r.kind==="Bucket"||r.kind==="AddressReservation")&&!r.isConsumed).map(r=>({kind:r.kind,name:r.name}));e(i)})},[])));u(this,"validationResultWithoutStaticValidation",X(this.enabledInstructions,t=>t.map(e=>e.validationResult)));u(this,"validationResult",tt(this.validationResultWithoutStaticValidation,1e3,async t=>{if(!(await t).valid)return t;const e=await this.toManifestString(),n=await st(e);if(n.valid)return A.ok();{const i=n.errors[0].message.replaceAll(/Radix Engine Toolkit error for invocation .* response is/g,"");let r=JSON.parse(i);for(;r.error!=null;)r=r.error;return A.error({message:r.toString(),context:"ManifestNode"})}}));this.id=t,this.label=f("")}async toManifestString(){let t=o(this.instructions);return(await Promise.all(t.filter(e=>o(e.enabled)).filter(e=>o(e.command)).map(e=>e.toManifestString()))).join(`

`)}async getBlobs(){return(await this.getAllValueNodes()).flatMap(e=>{if(e instanceof H){const n=o(e.value);if(n.kind==="Blob"&&n.data!=null)return[n.data.getDataHex()]}return[]})}insertNewInstruction(t){const e=o(this.instructions),n=e[t-1],s=e[t],i=new Lt(this);return i.setUpstreamOutputs((n==null?void 0:n.outputs)??f([])),s&&s.setUpstreamOutputs(i.outputs),e.splice(t,0,i),this.instructions.set(e),i}removeInstructionAtIndex(t){const e=o(this.instructions),n=e[t],s=e[t-1],i=e[t+1];n.unsubscribeAll(),i&&i.setUpstreamOutputs((s==null?void 0:s.outputs)??f([])),e.splice(t,1),this.instructions.set(e)}async getAllValueNodes(){return(await Promise.all(o(this.instructions).map(t=>t.getAllValueNodes()))).flat()}async toPersistableManifest(){const t=await Promise.all(o(this.instructions).map(e=>e.toPersistableInstruction()));return{id:this.id,label:o(this.label),transactionMessage:o(this.transactionMessage),instructions:t}}isFactuallyEmpty(){return o(this.instructions).find(t=>o(t.command)!=null)==null}}function Ut(a){return v(a,(t,e)=>{t.length===0&&e([]);const n=t.map(s=>s.enabled.subscribe(i=>{e(t.filter(r=>o(r.enabled)))}));return()=>n.forEach(s=>s())})}const fe=`${rt}manifests`,Wt=`${fe}:current`,zt=`${fe}:open`,Gt=`${fe}:recently-closed`,Ht=1e3;class Zt{constructor(){u(this,"activeManifestId");u(this,"openManifestIds");u(this,"recentlyClosedManifests");u(this,"openManifests");u(this,"activeManifest");this.activeManifestId=nt(Wt,void 0),this.openManifestIds=Ee(zt),this.recentlyClosedManifests=Ee(Gt);const t=o(this.activeManifestId),e=o(this.openManifestIds).flatMap(n=>{const s=x.loadManifestPairFromLocalStorage(n);if(!s)return console.error(`Manifest not found: ${n}`),[];const i=M.isDirty(s),r=s.savedVersion!=null,l=new x(n,s.currentVersion.label,i,r);if(n===t)try{return[l.load()]}catch(d){return Oe(n,d),new Array}else return[l]});this.openManifests=f(e),this.activeManifest=v(this.openManifests,n=>n.find(s=>s instanceof M))}activateManifest(t){try{const e=o(this.openManifests).map(n=>n instanceof M?n.unload():n.id===t?n.load():n);E(this.openManifests).set(e),E(this.activeManifestId).set(t)}catch(e){console.error(`An unexpected error occurred while loading persistent manifest ${t}:`,e),Ne({message:"Could not load manifest",type:"Error"})}}addManifestAndActivate(t,e,n){const s=o(this.openManifests).map(l=>l instanceof M?l.unload():l),i=new M(e,n,t,!1,!1),r=[...s,i];E(this.openManifests).set(r),this.openManifestIds.set(r.map(l=>l.id)),E(this.activeManifestId).set(e)}async createNewManifestAndActivate(t=!1){let e=new Pe;t&&e.insertNewInstruction(0),this.addManifestAndActivate(Promise.resolve(e),e.id,o(e.label))}async importManifestAndActivate(t,e=""){const[n,s]=Vt(t,e);try{await s,this.addManifestAndActivate(s,n,e)}catch(i){Oe(n,i)}}async importSharedManifestAndActivate(t){const e=se();try{const n=De({...t,id:e});await n,this.addManifestAndActivate(n,e,"<Importing...>")}catch(n){console.error(`Failed to load shared manifest ${e}:`,n),Ne({message:"Could not open manifest",type:"Error"})}}openRecentlyClosedManifest(t){const e=[...o(this.openManifests),new x(t.id,t.label,!1,!0)];E(this.openManifests).set(e),this.openManifestIds.set(e.map(n=>n.id)),this.activateManifest(t.id),this.recentlyClosedManifests.update(n=>n.filter(s=>s.id!==t.id))}async closeManifest(t,e){let n=o(this.openManifests);const s=t===o(this.activeManifestId),i=n.findIndex(d=>d.id===t);if(n.splice(i,1),s){const d=Math.max(i-1,0),c=n.length-1,m=Math.min(d,c),h=m>=0?n[m]:void 0;if(h)try{n[m]=h.load(),E(this.activeManifestId).set(void 0)}catch{E(this.activeManifestId).set(void 0)}else E(this.activeManifestId).set(void 0)}E(this.openManifests).set(n),this.openManifestIds.set(n.map(d=>d.id));const r=q(t),l=x.loadManifestPairFromLocalStorage(t);e==="save"?(l.savedVersion=l.currentVersion,localStorage.setItem(r,JSON.stringify(l)),this.recentlyClosedManifests.push({id:t,label:l.currentVersion.label})):l.savedVersion!=null?(l.currentVersion=l.savedVersion,localStorage.setItem(r,JSON.stringify(l)),this.recentlyClosedManifests.push({id:t,label:l.currentVersion.label})):localStorage.removeItem(r)}deleteRecentlyClosedManifest(t){if(new Set(o(this.openManifestIds)).has(t))throw new Error("Cannot delete currently open manifest");const n=q(t);localStorage.removeItem(n),this.recentlyClosedManifests.update(s=>s.filter(i=>i.id!==t))}}class M{constructor(t,e,n,s,i){u(this,"persistCurrentUnsubscriber");u(this,"labelSynchronizerUnsubscriber");u(this,"scheduledPersistLatestTimerId");u(this,"label");u(this,"isDirty");u(this,"hasSavedVersion");this.id=t,this.promisedManifestNode=n,this.label=f(e),this.isDirty=f(s),this.hasSavedVersion=f(i),n.then(r=>{this.persistCurrentUnsubscriber=v([r.validationResult,r.label,r.transactionMessage],D).subscribe(async l=>{this.scheduledPersistLatestTimerId&&clearTimeout(this.scheduledPersistLatestTimerId),this.scheduledPersistLatestTimerId=setTimeout(async()=>{const d=await M.persistLatestVersion(r);E(this.isDirty).set(d)},Ht)}),this.labelSynchronizerUnsubscriber=r.label.subscribe(l=>{E(this.label).set(l)})})}async save(){this.scheduledPersistLatestTimerId&&(clearTimeout(this.scheduledPersistLatestTimerId),this.scheduledPersistLatestTimerId=void 0);const t=await this.promisedManifestNode,e=await t.toPersistableManifest(),n=q(t.id),s={id:t.id,currentVersion:e,savedVersion:e};localStorage.setItem(n,JSON.stringify(s)),E(this.isDirty).set(!1)}static async persistLatestVersion(t){const e=await t.toPersistableManifest(),n=q(t.id),s=localStorage.getItem(n);if(s!=null){const i=JSON.parse(s);return i.currentVersion=e,localStorage.setItem(n,JSON.stringify(i)),this.isDirty(i)}else{const i={id:t.id,currentVersion:e};return localStorage.setItem(n,JSON.stringify(i)),!0}}static isDirty(t){return JSON.stringify(t.currentVersion)!==JSON.stringify(t.savedVersion)}unload(){var t,e;return(t=this.persistCurrentUnsubscriber)==null||t.call(this),(e=this.labelSynchronizerUnsubscriber)==null||e.call(this),new x(this.id,o(this.label),o(this.isDirty),o(this.hasSavedVersion))}}class x{constructor(t,e,n,s){u(this,"label");u(this,"isDirty");u(this,"hasSavedVersion");this.id=t,this.label=U(e),this.isDirty=U(n),this.hasSavedVersion=U(s)}load(){const t=x.loadManifestPairFromLocalStorage(this.id),e=t.currentVersion.label,n=De(t.currentVersion),s=M.isDirty(t),i=t.savedVersion!=null;return new M(this.id,e,n,s,i)}static loadManifestPairFromLocalStorage(t){const e=q(t),n=localStorage.getItem(e);return JSON.parse(n)}}function q(a){return`${fe}:${a}`}async function De(a){const t=new Pe(a.id);t.label.set(a.label),t.transactionMessage.set(a.transactionMessage);for(let e=0;e<a.instructions.length;e++){const n=a.instructions[e],s=t.insertNewInstruction(e);s.command.set(n.command),s.enabled.set(n.enabled),await $t(n,s)}return t}async function $t(a,t){const e=a.args;await new Promise(r=>setTimeout(r,1));let n=0;for(const r of o(t.fixedArgs)){const l=e[n];r.value.initializeFromPersistentValue(l.value),n++}const s=e.slice(n),i=await o(t.variableArgs)??[];for(let r=0;r<s.length;r++){const l=s[r];(i[r]??t.addArgument(j(l.value.kind,"consumes"))).value.initializeFromPersistentValue(l.value)}}function Oe(a,t){Ne({message:"Could not load manifest",type:"Error"}),console.error(`Failed to load persistent manifest ${a}:`,t)}const ns=new Zt;export{_t as A,Ct as E,xt as F,Tt as M,J as N,It as O,Mt as T,es as U,Dt as V,ts as a,ss as b,R as c,g as i,ns as m};
