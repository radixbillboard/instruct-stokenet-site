var q=Object.defineProperty;var Y=(e,n,t)=>n in e?q(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t;var k=(e,n,t)=>(Y(e,typeof n!="symbol"?n+"":n,t),t);import{P as Q,j as X,k as Z,T as tt,R as x,l as et,C as nt,S as at}from"./caching.bDzEPiSu.js";import{r as rt,h as C}from"./entityCache.NalFR0CB.js";const st="Input must be an string, Buffer or Uint8Array";function ot(e){let n;if(e instanceof Uint8Array)n=e;else if(typeof e=="string")n=new TextEncoder().encode(e);else throw new Error(st);return n}function it(e){return Array.prototype.map.call(e,function(n){return(n<16?"0":"")+n.toString(16)}).join("")}function T(e){return(4294967296+e).toString(16).substring(1)}function ct(e,n,t){let a=`
`+e+" = ";for(let r=0;r<n.length;r+=2){if(t===32)a+=T(n[r]).toUpperCase(),a+=" ",a+=T(n[r+1]).toUpperCase();else if(t===64)a+=T(n[r+1]).toUpperCase(),a+=T(n[r]).toUpperCase();else throw new Error("Invalid size "+t);r%6===4?a+=`
`+new Array(e.length+4).join(" "):r<n.length-2&&(a+=" ")}console.log(a)}function lt(e,n,t){let a=new Date().getTime();const r=new Uint8Array(n);for(let c=0;c<n;c++)r[c]=c%256;const i=new Date().getTime();console.log("Generated random input in "+(i-a)+"ms"),a=i;for(let c=0;c<t;c++){const y=e(r),m=new Date().getTime(),h=m-a;a=m,console.log("Hashed in "+h+"ms: "+y.substring(0,20)+"..."),console.log(Math.round(n/(1<<20)/(h/1e3)*100)/100+" MB PER SECOND")}}var F={normalizeInput:ot,toHex:it,debugPrint:ct,testSpeed:lt};const H=F;function _(e,n,t){const a=e[n]+e[t];let r=e[n+1]+e[t+1];a>=4294967296&&r++,e[n]=a,e[n+1]=r}function R(e,n,t,a){let r=e[n]+t;t<0&&(r+=4294967296);let i=e[n+1]+a;r>=4294967296&&i++,e[n]=r,e[n+1]=i}function M(e,n){return e[n]^e[n+1]<<8^e[n+2]<<16^e[n+3]<<24}function w(e,n,t,a,r,i){const c=U[r],y=U[r+1],m=U[i],h=U[i+1];_(s,e,n),R(s,e,c,y);let f=s[a]^s[e],b=s[a+1]^s[e+1];s[a]=b,s[a+1]=f,_(s,t,a),f=s[n]^s[t],b=s[n+1]^s[t+1],s[n]=f>>>24^b<<8,s[n+1]=b>>>24^f<<8,_(s,e,n),R(s,e,m,h),f=s[a]^s[e],b=s[a+1]^s[e+1],s[a]=f>>>16^b<<16,s[a+1]=b>>>16^f<<16,_(s,t,a),f=s[n]^s[t],b=s[n+1]^s[t+1],s[n]=b>>>31^f<<1,s[n+1]=f>>>31^b<<1}const P=new Uint32Array([4089235720,1779033703,2227873595,3144134277,4271175723,1013904242,1595750129,2773480762,2917565137,1359893119,725511199,2600822924,4215389547,528734635,327033209,1541459225]),ut=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3,11,8,12,0,5,2,15,13,10,14,3,6,7,1,9,4,7,9,3,1,13,12,11,14,2,6,5,10,4,0,15,8,9,0,5,7,2,4,10,15,14,1,11,12,6,8,3,13,2,12,6,10,0,11,8,3,4,13,7,5,15,14,1,9,12,5,1,15,14,13,4,10,0,7,6,3,9,2,8,11,13,11,7,14,12,1,3,9,5,0,15,4,8,6,2,10,6,15,14,9,11,3,0,8,12,2,13,7,1,4,10,5,10,2,8,4,7,6,1,5,15,11,9,14,3,12,13,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3],u=new Uint8Array(ut.map(function(e){return e*2})),s=new Uint32Array(32),U=new Uint32Array(32);function K(e,n){let t=0;for(t=0;t<16;t++)s[t]=e.h[t],s[t+16]=P[t];for(s[24]=s[24]^e.t,s[25]=s[25]^e.t/4294967296,n&&(s[28]=~s[28],s[29]=~s[29]),t=0;t<32;t++)U[t]=M(e.b,4*t);for(t=0;t<12;t++)w(0,8,16,24,u[t*16+0],u[t*16+1]),w(2,10,18,26,u[t*16+2],u[t*16+3]),w(4,12,20,28,u[t*16+4],u[t*16+5]),w(6,14,22,30,u[t*16+6],u[t*16+7]),w(0,10,20,30,u[t*16+8],u[t*16+9]),w(2,12,22,24,u[t*16+10],u[t*16+11]),w(4,14,16,26,u[t*16+12],u[t*16+13]),w(6,8,18,28,u[t*16+14],u[t*16+15]);for(t=0;t<16;t++)e.h[t]=e.h[t]^s[t]^s[t+16]}const p=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);function L(e,n,t,a){if(e===0||e>64)throw new Error("Illegal output length, expected 0 < length <= 64");if(n&&n.length>64)throw new Error("Illegal key, expected Uint8Array with 0 < length <= 64");if(t&&t.length!==16)throw new Error("Illegal salt, expected Uint8Array with length is 16");if(a&&a.length!==16)throw new Error("Illegal personal, expected Uint8Array with length is 16");const r={b:new Uint8Array(128),h:new Uint32Array(16),t:0,c:0,outlen:e};p.fill(0),p[0]=e,n&&(p[1]=n.length),p[2]=1,p[3]=1,t&&p.set(t,32),a&&p.set(a,48);for(let i=0;i<16;i++)r.h[i]=P[i]^M(p,i*4);return n&&(v(r,n),r.c=128),r}function v(e,n){for(let t=0;t<n.length;t++)e.c===128&&(e.t+=e.c,K(e,!1),e.c=0),e.b[e.c++]=n[t]}function O(e){for(e.t+=e.c;e.c<128;)e.b[e.c++]=0;K(e,!0);const n=new Uint8Array(e.outlen);for(let t=0;t<e.outlen;t++)n[t]=e.h[t>>2]>>8*(t&3);return n}function $(e,n,t,a,r){t=t||64,e=H.normalizeInput(e),a&&(a=H.normalizeInput(a)),r&&(r=H.normalizeInput(r));const i=L(t,n,a,r);return v(i,e),O(i)}function dt(e,n,t,a,r){const i=$(e,n,t,a,r);return H.toHex(i)}var ft={blake2b:$,blake2bHex:dt,blake2bInit:L,blake2bUpdate:v,blake2bFinal:O};const j=F;function bt(e,n){return e[n]^e[n+1]<<8^e[n+2]<<16^e[n+3]<<24}function g(e,n,t,a,r,i){o[e]=o[e]+o[n]+r,o[a]=E(o[a]^o[e],16),o[t]=o[t]+o[a],o[n]=E(o[n]^o[t],12),o[e]=o[e]+o[n]+i,o[a]=E(o[a]^o[e],8),o[t]=o[t]+o[a],o[n]=E(o[n]^o[t],7)}function E(e,n){return e>>>n^e<<32-n}const G=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),d=new Uint8Array([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3,11,8,12,0,5,2,15,13,10,14,3,6,7,1,9,4,7,9,3,1,13,12,11,14,2,6,5,10,4,0,15,8,9,0,5,7,2,4,10,15,14,1,11,12,6,8,3,13,2,12,6,10,0,11,8,3,4,13,7,5,15,14,1,9,12,5,1,15,14,13,4,10,0,7,6,3,9,2,8,11,13,11,7,14,12,1,3,9,5,0,15,4,8,6,2,10,6,15,14,9,11,3,0,8,12,2,13,7,1,4,10,5,10,2,8,4,7,6,1,5,15,11,9,14,3,12,13,0]),o=new Uint32Array(16),l=new Uint32Array(16);function N(e,n){let t=0;for(t=0;t<8;t++)o[t]=e.h[t],o[t+8]=G[t];for(o[12]^=e.t,o[13]^=e.t/4294967296,n&&(o[14]=~o[14]),t=0;t<16;t++)l[t]=bt(e.b,4*t);for(t=0;t<10;t++)g(0,4,8,12,l[d[t*16+0]],l[d[t*16+1]]),g(1,5,9,13,l[d[t*16+2]],l[d[t*16+3]]),g(2,6,10,14,l[d[t*16+4]],l[d[t*16+5]]),g(3,7,11,15,l[d[t*16+6]],l[d[t*16+7]]),g(0,5,10,15,l[d[t*16+8]],l[d[t*16+9]]),g(1,6,11,12,l[d[t*16+10]],l[d[t*16+11]]),g(2,7,8,13,l[d[t*16+12]],l[d[t*16+13]]),g(3,4,9,14,l[d[t*16+14]],l[d[t*16+15]]);for(t=0;t<8;t++)e.h[t]^=o[t]^o[t+8]}function V(e,n){if(!(e>0&&e<=32))throw new Error("Incorrect output length, should be in [1, 32]");const t=n?n.length:0;if(n&&!(t>0&&t<=32))throw new Error("Incorrect key length, should be in [1, 32]");const a={h:new Uint32Array(G),b:new Uint8Array(64),c:0,t:0,outlen:e};return a.h[0]^=16842752^t<<8^e,t>0&&(B(a,n),a.c=64),a}function B(e,n){for(let t=0;t<n.length;t++)e.c===64&&(e.t+=e.c,N(e,!1),e.c=0),e.b[e.c++]=n[t]}function J(e){for(e.t+=e.c;e.c<64;)e.b[e.c++]=0;N(e,!0);const n=new Uint8Array(e.outlen);for(let t=0;t<e.outlen;t++)n[t]=e.h[t>>2]>>8*(t&3)&255;return n}function W(e,n,t){t=t||32,e=j.normalizeInput(e);const a=V(t,n);return B(a,e),J(a)}function ht(e,n,t){const a=W(e,n,t);return j.toHex(a)}var wt={blake2s:W,blake2sHex:ht,blake2sInit:V,blake2sUpdate:B,blake2sFinal:J};const I=ft,A=wt;var pt={blake2b:I.blake2b,blake2bHex:I.blake2bHex,blake2bInit:I.blake2bInit,blake2bUpdate:I.blake2bUpdate,blake2bFinal:I.blake2bFinal,blake2s:A.blake2s,blake2sHex:A.blake2sHex,blake2sInit:A.blake2sInit,blake2sUpdate:A.blake2sUpdate,blake2sFinal:A.blake2sFinal};class D{constructor(n,t,a){this.fileName=n,this.data=t,this.dataHash=a}static async fromFile(n){const t=await rt(n),a=this.computeBlobHash(t);return new D(n.name,t,a)}getDataHex(){return this.data.reduce((n,t)=>n+t.toString(16).padStart(2,"0"),"")}static computeBlobHash(n){return pt.blake2bHex(n,void 0,32)}}class gt{constructor(){k(this,"privateKey",new Q.Secp256k1("40c1b9deccc56c0da69821dd652782667b5d31fe6bf6ead519a23f9e9472b49b"));k(this,"publicKey",this.privateKey.publicKey());k(this,"networkId",2);k(this,"faucetAddress","component_tdx_2_1cptxxxxxxxxxfaucetxxxxxxxxx000527798379xxxxxxxxxyulkzl");k(this,"gatewayApi");const n=X({dAppDefinitionAddress:"",networkId:this.networkId,providers:{}});this.gatewayApi=n.gatewayApi,n.destroy()}async sendTransactionToWallet(n){try{let{notarizedTransactionHex:t,transactionIdHex:a}=await this.prepareTransaction(n);await this.gatewayApi.transaction.innerClient.transactionSubmit({transactionSubmitRequest:{notarized_transaction_hex:t}});const r=await this.waitForTerminalStatus(a,2e4);return{success:!0,transactionIntentHash:a,status:r}}catch(t){return{success:!1,error:t.message}}}async prepareTransaction(n){const t=await this.prependLockFeeInstruction(n),a=await this.getCurrentEpoch();let r={networkId:this.networkId,startEpochInclusive:a,endEpochExclusive:a+2,nonce:Z(),notaryPublicKey:this.publicKey,notaryIsSignatory:!0,tipPercentage:0},c=await(await tt.new()).header(r).manifest(t).sign(this.privateKey).notarize(this.privateKey);const y=await x.NotarizedTransaction.intentHash(c);if((await x.NotarizedTransaction.staticallyValidate(c,et(this.networkId))).kind==="Invalid")throw new Error("Transaction is invalid");const h=await x.NotarizedTransaction.compile(c);return{notarizedTransactionHex:nt.Uint8Array.toHexString(h),transactionIdHex:y.id}}async getCurrentEpoch(){return(await this.gatewayApi.status.getCurrent()).ledger_state.epoch}async prependLockFeeInstruction(n){const{instructions:t,blobs:a}=n,r=await x.Instructions.convert(t,this.networkId,"String");if(r.kind!=="String")throw new Error("Unreachable");return{instructions:{kind:"String",value:`CALL_METHOD Address("${this.faucetAddress}") "lock_fee" Decimal("1000");
${r.value}`},blobs:a}}async waitForTerminalStatus(n,t){const a=Date.now()+t;let r;do switch(r=(await this.gatewayApi.transaction.getStatus(n)).status,r){case"Unknown":case"Pending":await new Promise(c=>setTimeout(c,1e3));continue;default:return r}while(Date.now()<a);return r}}const S=new gt,mt="component_tdx_2_1cpkl3ygh9nchpd2cflx2xxcy6sxp2rpy780pq4gcynedk7gmyaz5vt",yt="internal_keyvaluestore_tdx_2_1kz4m2nfk55te202xfa2cxghjvljmk0sdz3a40hu8ry0phn04eea900";class kt{async storeItem(n){const t=D.computeBlobHash(n),a={kind:"String",value:`CALL_METHOD Address("${mt}") "create" Blob("${t}");`},i={instructions:await x.Instructions.convert(a,S.networkId,"Parsed"),blobs:[n]},c=await S.sendTransactionToWallet(i);if(c.success&&c.status==="CommittedSuccess"){const m=(await S.gatewayApi.transaction.getCommittedDetails(c.transactionIntentHash)).transaction.receipt.output,h=C(m[1].hex),f=await x.ScryptoSbor.decodeToString(h,S.networkId,at.Programmatic);return JSON.parse(f).value}else throw console.log("Failed to store data:",c),new Error("Failed to store data")}async retrieveItem(n){try{const t=await S.gatewayApi.state.innerClient.keyValueStoreData({stateKeyValueStoreDataRequest:{key_value_store_address:yt,keys:[{key_json:{kind:"String",value:n}}]}});if(t.entries.length===0)return;const a=t.entries[0].value;return a.programmatic_json.kind!=="Bytes"?void 0:C(a.programmatic_json.hex)}catch(t){console.log(`Failed to retrieve manifest: ${t}`);return}}}const z=new kt;class xt{async shareManifest(n){const t=JSON.stringify(n),a=new TextEncoder().encode(t);return z.storeItem(a)}async retrieveManifest(n){try{const t=await z.retrieveItem(n);if(t==null)return;const a=new TextDecoder().decode(t);return JSON.parse(a)}catch(t){console.log("Failed to retrieve shared manifest:",t);return}}}const Ut=new xt;export{D as B,Ut as m};
